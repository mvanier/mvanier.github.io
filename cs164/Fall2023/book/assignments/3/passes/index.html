
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://example.com/assignments/3/passes/">
      
      
        <link rel="prev" href="../overview/">
      
      
        <link rel="next" href="../testing/">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.17">
    
    
      
        <title>Compiler passes - The CS 164 book (Fall 2023)</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.26e3688c.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#assignment-3-compiler-passes" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="The CS 164 book (Fall 2023)" class="md-header__button md-logo" aria-label="The CS 164 book (Fall 2023)" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            The CS 164 book (Fall 2023)
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Compiler passes
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to medium mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to medium mode" for="__palette_3" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="medium" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_3">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18V6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-2.69L23.31 12 20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69Z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="The CS 164 book (Fall 2023)" class="md-nav__button md-logo" aria-label="The CS 164 book (Fall 2023)" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    The CS 164 book (Fall 2023)
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Introduction
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Introduction
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../intro/welcome/" class="md-nav__link">
        Welcome to CS 164!
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../intro/language/" class="md-nav__link">
        Implementation Language
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Administrative
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Administrative
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../admin/syllabus/" class="md-nav__link">
        Syllabus
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../admin/collab/" class="md-nav__link">
        Collaboration policies
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../admin/groups/" class="md-nav__link">
        Groups
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          OCaml
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          OCaml
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ocaml/install/" class="md-nav__link">
        Installing OCaml
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ocaml/macos/" class="md-nav__link">
        Notes on MacOS
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
      
      
      
        <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
          Coding notes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          Coding notes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ocaml/notes/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ocaml/notes/basic/" class="md-nav__link">
        Basic tips
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ocaml/notes/functional/" class="md-nav__link">
        Functional programming
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ocaml/notes/types/" class="md-nav__link">
        Type annotations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ocaml/notes/new_features/" class="md-nav__link">
        New features
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ocaml/notes/design/" class="md-nav__link">
        Design tips
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ocaml/notes/debug/" class="md-nav__link">
        Debugging
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ocaml/notes/sexp/" class="md-nav__link">
        S-expressions
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          Assignments
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Assignments
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../0/" class="md-nav__link">
        Assignment 0: Setup
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
      
      
      
        <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
          Assignment 1: Var
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5_2">
          <span class="md-nav__icon md-icon"></span>
          Assignment 1: Var
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../1/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../1/passes/" class="md-nav__link">
        Compiler passes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../1/testing/" class="md-nav__link">
        Testing
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
      
      
      
        <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
          Assignment 2: Register allocation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5_3">
          <span class="md-nav__icon md-icon"></span>
          Assignment 2: Register allocation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2/passes/" class="md-nav__link">
        Compiler passes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2/testing/" class="md-nav__link">
        Testing
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4" checked>
      
      
      
        <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
          Assignment 3: Conditionals
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_5_4">
          <span class="md-nav__icon md-icon"></span>
          Assignment 3: Conditionals
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Compiler passes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Compiler passes
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-shrink-shrinkml" class="md-nav__link">
    1. Shrink (shrink.ml)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-uniquify-uniquifyml" class="md-nav__link">
    2. Uniquify (uniquify.ml)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-remove-complex-operands-remove_complexml" class="md-nav__link">
    3. Remove complex operands (remove_complex.ml)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-explicate-control-explicate_controlml" class="md-nav__link">
    4. Explicate control (explicate_control.ml)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-remove-unused-blocks-remove_unusedml" class="md-nav__link">
    5. Remove unused blocks (remove_unused.ml)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-select-instructions-select_instructionsml" class="md-nav__link">
    6. Select instructions (select_instructions.ml)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-uncover-live-uncover_liveml" class="md-nav__link">
    7. Uncover live (uncover_live.ml)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-build-interference-graph-build_interferenceml" class="md-nav__link">
    8. Build interference graph (build_interference.ml)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-graph-coloring-graph_coloringml" class="md-nav__link">
    9. Graph coloring (graph_coloring.ml)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-allocate-registers-allocate_registersml" class="md-nav__link">
    10. Allocate registers (allocate_registers.ml)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-remove-jumps-remove_jumpsml" class="md-nav__link">
    11. Remove jumps (remove_jumps.ml)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-patch-instructions-patch_instructionsml" class="md-nav__link">
    12. Patch instructions (patch_instructions.ml)
  </a>
  
    <nav class="md-nav" aria-label="12. Patch instructions (patch_instructions.ml)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setcc" class="md-nav__link">
    setCC
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xorq" class="md-nav__link">
    xorq
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#movzbq" class="md-nav__link">
    movzbq
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cmpq" class="md-nav__link">
    cmpq
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-prelude-and-conclusion-prelude_conclusionml" class="md-nav__link">
    13. Prelude and conclusion (prelude_conclusion.ml)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#submitting-your-assignment" class="md-nav__link">
    "Submitting" your assignment
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../testing/" class="md-nav__link">
        Testing
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-shrink-shrinkml" class="md-nav__link">
    1. Shrink (shrink.ml)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-uniquify-uniquifyml" class="md-nav__link">
    2. Uniquify (uniquify.ml)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-remove-complex-operands-remove_complexml" class="md-nav__link">
    3. Remove complex operands (remove_complex.ml)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-explicate-control-explicate_controlml" class="md-nav__link">
    4. Explicate control (explicate_control.ml)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-remove-unused-blocks-remove_unusedml" class="md-nav__link">
    5. Remove unused blocks (remove_unused.ml)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-select-instructions-select_instructionsml" class="md-nav__link">
    6. Select instructions (select_instructions.ml)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-uncover-live-uncover_liveml" class="md-nav__link">
    7. Uncover live (uncover_live.ml)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-build-interference-graph-build_interferenceml" class="md-nav__link">
    8. Build interference graph (build_interference.ml)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-graph-coloring-graph_coloringml" class="md-nav__link">
    9. Graph coloring (graph_coloring.ml)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-allocate-registers-allocate_registersml" class="md-nav__link">
    10. Allocate registers (allocate_registers.ml)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-remove-jumps-remove_jumpsml" class="md-nav__link">
    11. Remove jumps (remove_jumps.ml)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-patch-instructions-patch_instructionsml" class="md-nav__link">
    12. Patch instructions (patch_instructions.ml)
  </a>
  
    <nav class="md-nav" aria-label="12. Patch instructions (patch_instructions.ml)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setcc" class="md-nav__link">
    setCC
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xorq" class="md-nav__link">
    xorq
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#movzbq" class="md-nav__link">
    movzbq
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cmpq" class="md-nav__link">
    cmpq
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-prelude-and-conclusion-prelude_conclusionml" class="md-nav__link">
    13. Prelude and conclusion (prelude_conclusion.ml)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#submitting-your-assignment" class="md-nav__link">
    "Submitting" your assignment
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="assignment-3-compiler-passes">Assignment 3: Compiler passes</h1>
<p>The compiler passes are described in chapter 4 of the textbook,
but here they are again for completeness.
(You should still read the book for a more in-depth explanation!)
We will only include passes that you have to implement.
As before, the only files you should modify are the <code>.ml</code> files
corresponding to these compiler passes.</p>
<h3 id="1-shrink-shrinkml">1. Shrink (<code>shrink.ml</code>)</h3>
<p>This is a new pass.
Its purpose is to remove the <code>and</code> and <code>or</code> forms
by translating them to <code>if</code> expressions using this translation:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>(and e1 e2) --&gt; (if e1 e2 #f)
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>(or e1 e2)  --&gt; (if e1 #t e2)
</span></code></pre></div>
<p>This pass converts from the <code>Lif</code> language to the <code>Lif_shrink</code> language.
The only difference between them is that in <code>Lif_shrink</code>,
the <code>And</code> and <code>Or</code> constructors have been removed.</p>
<h3 id="2-uniquify-uniquifyml">2. Uniquify (<code>uniquify.ml</code>)</h3>
<p>This is essentially the same as the "uniquify" pass for the "Var" language
compiler, except that you have to add a case for the <code>If</code> constructor,
and all the operators have been combined in the <code>Prim</code> constructor.</p>
<h3 id="3-remove-complex-operands-remove_complexml">3. Remove complex operands (<code>remove_complex.ml</code>)</h3>
<p>The "remove complex operands" pass is essentially the same
as in the "Var" compiler,
except for the necessary changes to accommodate the new language forms
and the folding of operator expressions into the <code>Prim</code> constructor.
Note that all three operands of an <code>if</code> expression can be complex.</p>
<h3 id="4-explicate-control-explicate_controlml">4. Explicate control (<code>explicate_control.ml</code>)</h3>
<p>The "explicate control" pass has significant changes from the previous compiler.
This pass converts code in the "Lif_mon" language to the "Cif" language.
The "Cif" language is like "Cvar" from the previous compiler,
but with these changes/additions:</p>
<ul>
<li>a <code>Bool</code> constructor for boolean literals</li>
<li>operator expressions using the <code>Prim</code> constructor used in the
  "Lif" languages</li>
<li>
<p>extra <code>tail</code> constructors:</p>
<ul>
<li><code>Goto</code> for unconditional jumps</li>
<li><code>IfStmt</code> for conditional jumps</li>
</ul>
</li>
</ul>
<p>The most significant change are conditional jumps
represented by the <code>IfStmt</code> constructor of the <code>tail</code> datatype,
because then the code can go in one of two directions.
The <code>IfStmt</code> constructor looks like this:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>IfStmt of {
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>  op : cmp_op;
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>  arg1 : atm;
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>  arg2 : atm;
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>  jump_then : label;
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>  jump_else : label;
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>}
</span></code></pre></div>
<p>This corresponds to a comparison operator which jumps to one label
if the comparison returns "true" (<code>#t</code>)
or to the other label if the comparison returns "false" (<code>#f</code>).
The labels correspond to blocks of instructions,
so the entire code is represented as a set of labelled blocks,
which we refer to as "basic blocks".</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A "basic block" is a sequence of instructions that has no
internal jumps <em>i.e.</em> if there are any jump instructions
(like <code>Goto</code> or <code>IfStmt</code> in the "Cif" language)
they only appear at the end of the block.</p>
</div>
<p>With code represented as a set of basic blocks connected by jumps,
the code representation is abstractly a graph, not a tree.
In particular,
code in the "Cif" language corresponds to a <em>directed acyclic graph</em> (DAG),
which we will discuss more below.</p>
<p>The "explicate control" pass from the previous compiler has these functions:</p>
<ul>
<li>a function to convert atoms (<code>convert_atom</code>)</li>
<li>a function to convert expressions (<code>convert_exp</code>)</li>
<li>a function to convert assignments (<code>explicate_assign</code>)</li>
<li>a function to convert expressions in "tail position" (<code>explicate_tail</code>)</li>
</ul>
<p>All of these are straightforward functions to implement.</p>
<p>For this compiler, we need to extend these functions
to deal with the new language constructs,
and we need to define an additional one for conditional expressions
(<code>explicate_pred</code>).</p>
<p>The <code>convert_atom</code> function needs to be extended to deal with the new
<code>Bool</code> constructor, which is trivial.</p>
<p>The <code>convert_exp</code> function needs to handle operator expressions
differently to reflect the new <code>Prim</code> constructor.
Neither the <code>Let</code> nor the <code>If</code> constructor of the "Lif_mon" language
should be handled here.</p>
<p>The <code>explicate_assign</code> function has to deal with <code>if</code> expressions
in <code>let</code> bindings.  This is essentially this transformation:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>(let (y (if e1 e2 e3)) tl)
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>--&gt;
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>(if e1 (let (y e2) tl) (let (y e3) tl))
</span></code></pre></div>
<p>except that the tails (<code>tl</code>) are not duplicated.  This can be achieved
by converting the tail to a block using the (provided) <code>create_block</code>
function and then using a <code>Goto</code> to that block for each tail.
To convert the <code>if</code> expression itself
requires the <code>explicate_pred</code> function, described below.</p>
<p>The <code>explicate_tail</code> function needs to be extended
to handle <code>if</code> expressions. This also requires a call to <code>explicate_pred</code>.</p>
<p>Now we get to <code>explicate_pred</code>,
which is the most complicated function of the pass.
It's the function that is called to convert <code>if</code> expressions,
as we've seen.
The arguments are:</p>
<ul>
<li>a boolean-valued test expression</li>
<li>tails for the "then" and "else" clauses of the <code>if</code> expression</li>
</ul>
<p>The most straightforward case is where
the test expression is an operator expression using a comparison operation.
In that case, an <code>IfStmt</code> tail can be generated immediately.</p>
<p>Another simple case is when the test expression is a literal boolean.
In that case, either the "then" tail or the "else" tail
can be returned immediately (depending on the boolean's value).
Negated literal booleans can be handled similarly.
(This is an example of partial evaluation.)</p>
<p>If the test case is a boolean-valued variable,
this can be converted to an equality comparison: <code>v</code> becomes
<code>(eq v #t)</code>.</p>
<p>This leaves two trickier cases,
both of which can be described in terms of the transformations needed
to compile them.</p>
<ol>
<li>
<p>The test expression is a <code>let</code>,
   which means that the original <code>if</code> expression
   is a <code>let</code> inside an <code>if</code>.
   This is compiled using this transformation:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>(if (let (x e1) e2) then_tl else_tl)
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>--&gt;
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>(let (x e1) (if e2 then_tl else_tl))
</span></code></pre></div>
<p>Of course, the <code>let</code> output ends up becoming an
<code>Assign</code> statement in the "Cif" language.</p>
</li>
<li>
<p>The test expression is another <code>if</code> expression,
   which means that the original <code>if</code> expression
   is an <code>if</code> inside an <code>if</code>.
   This is compiled using this transformation:</p>
</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>(if (if e1 e2 e3) then_tl else_tl)
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>--&gt;
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>(if e1 (if e2 then_tl else_tl) (if e3 then_tl else_tl))
</span></code></pre></div>
<p>It's important not to duplicate the tails, so convert them
   to labels using the <code>create_block</code> function.
   This will also require recursive calls to <code>explicate_pred</code>.</p>
<p>One curious aspect of this pass is that we use imperative programming.
We have a global reference to a map between labels and blocks
to keep track of the basic blocks.
We could have done this using extra arguments,
but we felt that it was simpler with this small amount of
imperative programming.<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup></p>
<h3 id="5-remove-unused-blocks-remove_unusedml">5. Remove unused blocks (<code>remove_unused.ml</code>)</h3>
<p>The "remove unused blocks" pass takes in a program in the "Cif"
intermediate language and also returns a program in this language.
Its job is to remove any blocks that can never be reached.
This could happen, for instance, if the test operand of an <code>if</code>
expression is <code>#t</code>.
In this kind of situation, any code generated by the "else" case will
end up in an unused block, since no other block will jump to it.
(Although the compilation of the <code>if</code> in <code>explicate_pred</code>
will discard the unused tail, the block corresponding to the tail
will have already been compiled, and it will become part of the output
of the "explicate control" pass.)
There is no point in having such blocks in the code, so this pass
removes them.<sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup></p>
<p>The basic algorithm is as follows:</p>
<ul>
<li>Start with a list of (label, tail) pairs.
  (This is the way programs are represented in the "Cif" language.)</li>
<li>Convert it to a label to tail map.</li>
<li>Compute the set of all labels that are reachable from the "start" label.
  You probably will want to write one or more helper functions to do this.
  The <code>get_jump_labels</code> function in the <code>Cif</code> module will be useful.</li>
<li>Compute a list of (label, tail) pairs which only includes the
  reachable labels; this is used to generate the output program.</li>
</ul>
<p>To figure out which labels are reachable from the "start" label,
use <code>get_jump_labels</code> to find the successors of "start",
then find the successors of each of these, <em>etc.</em> until every reachable
label has been found.</p>
<p>This pass is short and should be fairly straightforward to implement.</p>
<h3 id="6-select-instructions-select_instructionsml">6. Select instructions (<code>select_instructions.ml</code>)</h3>
<p>The "select instructions" pass converts programs from the "Cif"
intermediate language to the "X86_var_if" intermediate language.
Overall, it is structured in the same way as it is in the "Var" compiler,
but with a number of additions to deal with the new forms of the "Cond"
language.</p>
<p>The new atom case for booleans is converted to one of the integers <code>0</code>
(false) or <code>1</code> (true).
These integers are stored in a one-byte segment of a register.
(We never put more than one boolean in a register.)</p>
<p>There are a number of new assembly language instructions that are generated:</p>
<ul>
<li><code>xorq &lt;arg1&gt;, &lt;arg2&gt;</code> (XOR: used for logical negation)</li>
<li><code>cmpq &lt;arg1&gt;, &lt;arg2&gt;</code> (used for comparisons)</li>
<li><code>setCC &lt;arg&gt;</code>
  (sets a byte based on the contents of the <code>%rflags</code> register)</li>
<li><code>movzbq &lt;arg1&gt;, &lt;arg2&gt;</code> (move from a one-byte register to a full register)</li>
<li><code>jCC &lt;label&gt;</code> (conditionally jump to a label)</li>
</ul>
<p>This needs a bit more explanation.</p>
<p>To negate a boolean variable (which is represented as <code>0</code> for false or
<code>1</code> for true), compute <code>xorq $1, &lt;var&gt;</code> (where <code>$1</code> is just the number 1
in assembly syntax <em>i.e.</em> an "immediate" value).</p>
<p>The <code>cmpq</code> instruction takes two arguments, compares them, and uses the
comparison to set a special "flags" register called <code>%rflags</code>.<sup id="fnref:3"><a class="footnote-ref" href="#fn:3">3</a></sup>
It takes its arguments in backwards order, so to test if <code>x &lt; y</code>, do
<code>cmpq y, x</code>.  The <code>%rflags</code> register can't be read directly,
but the <code>setCC</code> family of instructions can set a byte based on its value.
Specifically, the <code>CC</code> (condition code) in <code>setCC</code> is one of:</p>
<ul>
<li><code>e</code>  (for "equal")</li>
<li><code>l</code>  (for "less than")</li>
<li><code>le</code> (for "less than or equal")</li>
<li><code>g</code>  (for "greater than")</li>
<li><code>ge</code> (for "greater than or equal")</li>
</ul>
<p>So if the instruction <code>cmpq y, x</code> was done, and <code>x</code> was less than <code>y</code>,
the subsequent instruction <code>setl &lt;var&gt;</code> would set <code>&lt;var&gt;</code> to <code>1</code>,
since <code>setl</code> means
"set <code>&lt;var&gt;</code> to <code>1</code>
if the <code>%rflags</code> register indicates that the last comparison
yielded a less-than result".
As if this wasn't weird enough,
the <code>&lt;var&gt;</code> argument of <code>setCC</code> instructions
can only be a byte register (a one-byte segment of a full register).
We only use the <code>al</code> byte register, which is part of the <code>%rax</code> register,
though in principle many more byte registers could be used.
(In the code, byte registers are a new constructor of the <code>arg</code> type
called <code>ByteReg</code>.)</p>
<p>Since the <code>setCC</code> instructions can only set byte registers,
but we normally work with full registers,
we need to be able to "move" a byte register into a full register,
which is what the <code>movzbq</code> instruction does.
Specifically, we will move from the <code>al</code> byte register
(which is the only such register we use)
to any full register we want.</p>
<p>The <code>jCC</code> family of instructions represents conditional jumps;
the possible <code>CC</code> values are the same as for the <code>setCC</code> instructions.
To give an example, the <code>jle &lt;label&gt;</code> instruction jumps to the label
<code>&lt;label&gt;</code> if the value of the <code>%rflags</code> register indicates that
the last <code>cmpq</code> instruction yielded a less-than-or-equal result.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code>jCC</code> family of instructions are represented by the
<code>JmpIf</code> instruction in the intermediate languages.</p>
</div>
<p>The textbook (section 4.9) describes the translations between <code>Cif</code>
instructions and <code>X86_var_if</code> instructions.</p>
<h3 id="7-uncover-live-uncover_liveml">7. Uncover live (<code>uncover_live.ml</code>)</h3>
<p>This pass has very significant changes, because the "Cond" language can
yield code with multiple blocks (not counting the prelude and conclusion),
and we have to know how to do the liveness analysis with these blocks.</p>
<p>In the previous compiler, we only had one block to deal with,
and we computed the liveness sets for each instruction
starting from the end of the block
and working back towards the beginning.
The liveness set at the end was set to be the registers <code>%rax</code> and <code>%rsp</code>,
which are used in the <code>conclusion</code> block.</p>
<p>For this compiler, we use a similar strategy per block, but since there are
multiple blocks, we have to know in which order to handle them.
In addition, we have to know what the liveness set is at the end of each block
so that we can use that to work backwards towards the beginning.</p>
<p>Because we only have conditional expressions and not loops,
and because conditional expressions can only jump forwards in the code,
the directed graph formed by the blocks (the graph vertices or nodes)
and the jumps between blocks (the graph edges)
is a <em>directed acyclic graph</em> or "DAG".
Lecture 12 has some pictures of DAGs formed from code blocks,
which we won't repeat here.
The endpoint of the DAG is the <code>conclusion</code> block,
since this block has only incoming and no outgoing edges.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In general, DAGs can have more than one "leaf" node
(node with no outgoing edges)
but in our case, the <code>conclusion</code> block is the only one.
Control flow will always flow into the <code>conclusion</code> block eventually,
as the code progresses towards the end of the <code>main</code> function.</p>
</div>
<p>It stands to reason that, since we already know what the liveness set
at the beginning of the <code>conclusion</code> block is
(just the registers <code>%rax</code> and <code>%rsp</code>),
we should start liveness analysis in a block
that ends in a jump to that block.  But what about all the other blocks?</p>
<p>We need to do two things:</p>
<ol>
<li>
<p>Compute the order of the block labels
   so that we know in what order to compute the liveness sets.</p>
</li>
<li>
<p>After computing the liveness sets for a block, record the
   liveness set at the beginning of the block in a data structure;
   this will become the final liveness set of any block
   that jumps to this block.</p>
</li>
</ol>
<p>The way we deal with the first task is to compute a <em>directed graph</em>
of all the block labels by:</p>
<ol>
<li>collecting the jump labels from each block,</li>
<li>using them to compute the graph edges (label to label pairs),</li>
<li>and constructing the graph.</li>
</ol>
<p>This graph is (potentially) a "multigraph"
(meaning that there can be multiple edges between the same blocks),
although if compilation has proceeded correctly,
there should only be at most one edge between any two blocks.<sup id="fnref:4"><a class="footnote-ref" href="#fn:4">4</a></sup>
This graph will be a DAG.
If you have a list of (block label to block label) edges,
you can construct the graph using the <code>LabelMgraph.of_list</code> function.</p>
<!-- NOTE on multigraphs

You could, in theory, get an actual multigraph if both the jump targets
of an IfStmt were to the same block.
However, I don't think there is any way to actually write code
that will generate such an IfStmt.
It's strongly reminiscent of the optimizations in "select instructions"
that can never happen.

Also, in the event that there _was_ an IfStmt where both jumps
were to the same block, it should just be replaced with a Goto!

-->

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Before constructing the graph,
filter out the edges that contain the <code>conclusion</code> label,
since we won't be doing liveness analysis on the <code>conclusion</code> block!</p>
</div>
<p>Once we have the DAG, getting the right order of blocks
(actually block labels) is simple.
The DAG will point "forward" (towards the <code>conclusion</code> block),
but we want to compute liveness "backwards"
(starting from the blocks which project directly to the <code>conclusion</code> block).
To do this, we "flip the arrows" on the DAG,
which is known as "transposing" the graph.
This is not hard to do manually,
but the <code>LabelMgraph</code> module has a <code>transpose</code> function
that will do it for you.
After that, we need to order the labels so that
no label appears before all the labels that have edges to it
have already appeared.
This is known as a "topological sort", and (you guessed it)
there is a function called "topological_sort" in the <code>LabelMgraph</code> module.
So once you have the DAG, just transpose it and topologically sort it,
and you have the correct order of block labels!</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Topological sorts are in general not unique,
but if you use the library function the order of labels
you generate will be the same as the label order
in the instructor's compiler.</p>
</div>
<p>Once we have the order of the labels,
we create a map between labels and their live-before sets
called <code>live_before_labels</code>.
We initialize this with the live-before set of the <code>conclusion</code> block.
Then we process each block in the order of their labels,
and when we compute the live-before set for each block,
we add it to the <code>live_before_labels</code> map.
That way, each block will have the live-before set of all blocks
that the block can jump to precomputed
when the block's liveness sets are computed.</p>
<p>Computing liveness sets for individual blocks is done the same way
as in the previous compiler,
but with additional cases for the new instructions.
Most of the changes are obvious, but some are not.
<code>movzbq</code> instructions act like <code>movq</code> instructions
in terms of liveness calculations.
The <code>cmpq</code> instruction reads from both arguments
and writes to the <code>%rflags</code> register.
The <code>setCC</code> family reads from the <code>%rflags</code> register
and writes to its argument.</p>
<p><code>jmp</code> and <code>jmpIf</code> instructions require special treatment.
They only occur at the end of blocks, and there are only two cases
we will encounter.</p>
<ol>
<li>
<p>The block ends in a <code>jmpIf</code> instruction followed by a <code>jmp</code>
   instruction.</p>
</li>
<li>
<p>The block ends in a <code>jmp</code> instruction without a <code>jmpIf</code>
   preceding it.</p>
</li>
</ol>
<p>The second case is easy; we look up the jump target label in the
<code>live_before_labels</code> map, and the live-before set we find
is also the live-before set of the <code>jmp</code> instruction.</p>
<p>The first case is more subtle.
For the <code>jmp</code> instruction which follows the <code>jmpIf</code> instruction,
we again just make the live-before set of the jump target
the live-before set of the instruction.
For the <code>jmpIf</code> instruction, we have <em>two</em> jump targets:
the one from the following <code>jmp</code> instruction
and the one from the label in the <code>jmpIf</code> instruction itself.
We need to compute the <em>union</em> of the live-before sets from both jump targets,
since we have no way of knowing which block the instruction will jump to.
So we union the live-before set of the <code>jmpIf</code> instruction's target
with the live-before set from the <code>jmp</code> instruction to compute
the live-before set of the <code>jmpIf</code> instruction.
Then we compute the liveness set of each instruction in the block as usual.</p>
<p>That's all for this pass!
Fortunately, the rest of the passes are much simpler.</p>
<h3 id="8-build-interference-graph-build_interferenceml">8. Build interference graph (<code>build_interference.ml</code>)</h3>
<p>The main changes needed here are to accommodate the new assembly instructions.
The <code>movzbq</code> instruction should be handled like a <code>movq</code> instruction.
Byte registers need to be converted to their corresponding registers;
there is a function <code>reg_of_bytereg</code> in the <code>Types</code> module
that may be useful.  You should consider the destination of the <code>cmpq</code>
instruction to be the <code>%rflags</code> register.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This could possiblly have been left out, since <code>%rflags</code> isn't
a register used for register allocation, but we put it in for
completeness.  It doesn't cause problems, since we always read
from <code>%rflags</code> immediately after writing to it.</p>
</div>
<p>Everything else is pretty much as you'd expect.</p>
<h3 id="9-graph-coloring-graph_coloringml">9. Graph coloring (<code>graph_coloring.ml</code>)</h3>
<p>The graph coloring code is unchanged from the previous assignment.<sup id="fnref:5"><a class="footnote-ref" href="#fn:5">5</a></sup></p>
<h3 id="10-allocate-registers-allocate_registersml">10. Allocate registers (<code>allocate_registers.ml</code>)</h3>
<p>We've added a couple of features to the template code for the
"allocate registers" pass.
The register color list includes the <code>%rflags</code> register, with color <code>-6</code>.
A new function called <code>check_no_variables</code> checks
that the output of this pass contains no unresolved variable references.
(This could have been added to the previous compilers as well.)
Aside from this, the changes you need to make are in the <code>convert_instr</code>
function to handle the new assembly instructions.
The changes are very straightforward,
but you should check that the first argument of <code>movzbq</code>
and the argument of <code>setCC</code> instructions are byte registers.</p>
<h3 id="11-remove-jumps-remove_jumpsml">11. Remove jumps (<code>remove_jumps.ml</code>)</h3>
<p>This is an optimization pass which is an optional pass in the textbook.
It's fairly simple to implement, so we're making it mandatory.
<img alt="" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@14.1.2/assets/svg/1f601.svg" title=":grin:" /></p>
<p>The pseudocode for the algorithm is given in the file <code>remove_jumps.ml</code>,
as well as stubs for the functions we used.
(You can replace them with your functions if you like,
as long as you don't change the module interface.)
Note that we define a <code>get_jump_labels</code> function
which has the same name as a function in the <code>Cif</code> module,
but is different because it takes an <code>X86_var_if</code> block as its argument,
whereas the other took a <code>Cif</code> tail.</p>
<p>This code also uses directed graphs (not multigraphs),
which are implemented in the <code>support/dgraph.ml[i]</code> files.
(We could have used multigraphs,
but the actual graphs only have at most one edge between blocks.)
We start the algorithm by converting the (label, block) list into a directed
graph.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When building the label graph, do not include the <code>conclusion</code>
label, because we don't allow merging with the <code>conclusion</code> block.</p>
</div>
<p>In the <code>merge_blocks</code> function, we used two utility functions from the
<code>Utils</code> module: <code>last</code> and <code>butlast</code> to get the last element in a list,
and all but the last element, respectively.</p>
<p>The algorithm consists of finding two labels which correspond to blocks that
can be merged, and merging them using the <code>merge_blocks</code> function and the
<code>merge_vertices</code> function of the <code>LabelDgraph</code> module.  (The latter is
needed because when you merge two blocks, the label of the second block goes
away.)  We find mergeable labels using the <code>get_mergeable_labels</code> function,
which returns a pair of mergeable labels if there is one.  We use the
<code>neighbors_in</code> and <code>neighbors_out</code> functions of the <code>LabelDgraph</code> module
to find the candidate pairs.  Essentially, we collect all labels with only one
out neighbor and look in those labels for one that has only one in neighbor.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It might be more efficient to find all pairs of mergeable labels,
but since merging two labels changes the graph, it's safer to do it one pair
at a time.  We're not trying for ultimate efficiency here.</p>
</div>
<p>The algorithm is repeated until there are no more mergeable blocks.</p>
<h3 id="12-patch-instructions-patch_instructionsml">12. Patch instructions (<code>patch_instructions.ml</code>)</h3>
<p>There are a few small additions that need to be made
to the "patch instructions" pass to handle the new assembly instructions.</p>
<h4 id="setcc"><code>setCC</code></h4>
<p>The argument of any of the <code>setCC</code> family of instructions
(<code>setl</code>, <code>setle</code>, <code>sete</code>, <code>setg</code>, <code>setge</code>)
must be a byte register, or it's an error.</p>
<h4 id="xorq"><code>xorq</code></h4>
<p>As with other operators, only one of the two operands of <code>xorq</code>
can be a stack location (<em>i.e.</em> a memory reference).</p>
<h4 id="movzbq"><code>movzbq</code></h4>
<p>The first argument to <code>movzbq</code> should be a byte register. <sup id="fnref:6"><a class="footnote-ref" href="#fn:6">6</a></sup>
It should already be a byte register, so if it isn't, that's an error.</p>
<p>The second argument must be a regular register. If it isn't (<em>e.g.</em> if it's a
stack location), replace the second argument with <code>%rax</code>
and then add a <code>movq</code> instruction to put the contents of <code>%rax</code>
into the second argument.</p>
<h4 id="cmpq"><code>cmpq</code></h4>
<p>As with other operators, only one of the two operands of <code>cmpq</code>
can be a stack location.</p>
<p>In addition, the second argument of <code>cmpq</code> can't be an immediate value,
so if it is, move it to <code>%rax</code> and use <code>%rax</code> instead.</p>
<h3 id="13-prelude-and-conclusion-prelude_conclusionml">13. Prelude and conclusion (<code>prelude_conclusion.ml</code>)</h3>
<p>The only changes to this pass from the previous compiler
are the obvious changes to handle the new assembly instructions
and byte registers.</p>
<h2 id="submitting-your-assignment">"Submitting" your assignment</h2>
<p>The assignment will be graded in your Github repository as usual,
in the <code>ch4</code> directory.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Of course, one nice thing about OCaml
is that you can choose to use imperative programming whenever it suits you,
and avoid it when it's unnecessary.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>This is one example of what is called <em>dead code elimination</em>
in the compiler literature, which means removing code which cannot
have any effect on the final result of a program.  Dead code comes in
many forms besides this.&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>The textbook incorrectly calls this EFLAGS,
which is an older name that is appropriate for 32-bit x86 systems only.&#160;<a class="footnote-backref" href="#fnref:3" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:4">
<p>The textbook insists on using multigraphs,
but in fact, regular directed graphs could have been used instead.
Nevertheless, this doesn't change the algorithm.&#160;<a class="footnote-backref" href="#fnref:4" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
<li id="fn:5">
<p>This is the benefit of programming an algorithm as a functor
that works on abstract values! Go OCaml! <img alt="" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@14.1.2/assets/svg/1f604.svg" title=":smile:" />&#160;<a class="footnote-backref" href="#fnref:5" title="Jump back to footnote 5 in the text">&#8617;</a></p>
</li>
<li id="fn:6">
<p>Technically, it could also be an immediate value,
but we won't be using it that way.&#160;<a class="footnote-backref" href="#fnref:6" title="Jump back to footnote 6 in the text">&#8617;</a></p>
</li>
</ol>
</div>





                
              </article>
            </div>
          
          
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../overview/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Overview" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Overview
              </div>
            </div>
          </a>
        
        
          
          <a href="../testing/" class="md-footer__link md-footer__link--next" aria-label="Next: Testing" rel="next">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Testing
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.copy", "navigation.footer", "navigation.top"], "search": "../../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.b425cdc4.min.js"></script>
      
        
          <script src="../../../js/mathjax.js"></script>
        
      
        
          <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        
      
        
          <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        
      
    
  </body>
</html>