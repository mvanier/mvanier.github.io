
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://example.com/assignments/1/passes/">
      
      
        <link rel="prev" href="../overview/">
      
      
        <link rel="next" href="../testing/">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.17">
    
    
      
        <title>Compiler passes - The CS 164 book (Fall 2023)</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.26e3688c.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#assignment-1-compiler-passes" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="The CS 164 book (Fall 2023)" class="md-header__button md-logo" aria-label="The CS 164 book (Fall 2023)" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            The CS 164 book (Fall 2023)
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Compiler passes
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to medium mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to medium mode" for="__palette_3" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="medium" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_3">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18V6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-2.69L23.31 12 20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69Z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="The CS 164 book (Fall 2023)" class="md-nav__button md-logo" aria-label="The CS 164 book (Fall 2023)" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    The CS 164 book (Fall 2023)
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Introduction
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Introduction
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../intro/welcome/" class="md-nav__link">
        Welcome to CS 164!
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../intro/language/" class="md-nav__link">
        Implementation Language
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Administrative
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Administrative
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../admin/syllabus/" class="md-nav__link">
        Syllabus
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../admin/collab/" class="md-nav__link">
        Collaboration policies
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../admin/groups/" class="md-nav__link">
        Groups
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          OCaml
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          OCaml
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ocaml/install/" class="md-nav__link">
        Installing OCaml
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ocaml/macos/" class="md-nav__link">
        Notes on MacOS
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
      
      
      
        <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
          Coding notes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          Coding notes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ocaml/notes/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ocaml/notes/basic/" class="md-nav__link">
        Basic tips
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ocaml/notes/functional/" class="md-nav__link">
        Functional programming
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ocaml/notes/types/" class="md-nav__link">
        Type annotations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ocaml/notes/new_features/" class="md-nav__link">
        New features
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ocaml/notes/design/" class="md-nav__link">
        Design tips
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ocaml/notes/debug/" class="md-nav__link">
        Debugging
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ocaml/notes/sexp/" class="md-nav__link">
        S-expressions
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          Assignments
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Assignments
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../0/" class="md-nav__link">
        Assignment 0: Setup
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" checked>
      
      
      
        <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
          Assignment 1: Var
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_5_2">
          <span class="md-nav__icon md-icon"></span>
          Assignment 1: Var
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Compiler passes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Compiler passes
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#uniquify" class="md-nav__link">
    Uniquify
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#remove-complex-operands" class="md-nav__link">
    Remove complex operands
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#explicate-control" class="md-nav__link">
    Explicate control
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#select-instructions" class="md-nav__link">
    Select instructions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#assign-homes" class="md-nav__link">
    Assign homes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patch-instructions" class="md-nav__link">
    Patch instructions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prelude-and-conclusion" class="md-nav__link">
    Prelude and conclusion
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../testing/" class="md-nav__link">
        Testing
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
      
      
      
        <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
          Assignment 2: Register allocation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5_3">
          <span class="md-nav__icon md-icon"></span>
          Assignment 2: Register allocation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2/passes/" class="md-nav__link">
        Compiler passes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2/testing/" class="md-nav__link">
        Testing
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4" >
      
      
      
        <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
          Assignment 3: Conditionals
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5_4">
          <span class="md-nav__icon md-icon"></span>
          Assignment 3: Conditionals
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../3/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../3/passes/" class="md-nav__link">
        Compiler passes
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#uniquify" class="md-nav__link">
    Uniquify
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#remove-complex-operands" class="md-nav__link">
    Remove complex operands
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#explicate-control" class="md-nav__link">
    Explicate control
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#select-instructions" class="md-nav__link">
    Select instructions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#assign-homes" class="md-nav__link">
    Assign homes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patch-instructions" class="md-nav__link">
    Patch instructions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prelude-and-conclusion" class="md-nav__link">
    Prelude and conclusion
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="assignment-1-compiler-passes">Assignment 1: Compiler passes</h1>
<p>This section describes the code you have to write.</p>
<p>The compiler passes are described in chapter 2 of the textbook,
but they are here again for completeness.
We will only include passes that you have to implement.
For example, even though the parser can be thought of as a "pass",
you don't have to implement it, so we don't include it here.
Similarly, the "print assembly" pass is provided for you,
as are all the intermediate languages and interpreters.<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup></p>
<p>Note that the <em>only</em> files you should modify are the files corresponding to
these compiler passes.  Also, only modify the <code>.ml</code> files; the <code>.mli</code>
files constitute the interface to these modules and must not be changed.</p>
<p>In addition, when we provide a function stub in a <code>.ml</code> file
that you need to complete,
that means that we expect that you will implement that function
(with those arguments and types (if supplied)) as written
(filling in the <code>TODO</code> parts, of course).
In particular, you're not allowed to change
the number of arguments to the function,
or their types (if supplied).
If a function is completely implemented (no <code>TODO</code>s),
you should leave it as-is.
On the other hand, you can write as many extra functions as you like.
(If we don't like your choices, we'll let you know during code reviews!)</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We expect that you will be using the functions
we require you to implement!
Don't implement a required function and then not use it later.
(This would generate a warning anyway.)</p>
</div>
<h2 id="uniquify">Uniquify</h2>
<p>[File: <code>uniquify.ml</code>.]</p>
<p>In this pass, all names bound in <code>let</code> expressions have to be renamed
to be unique.  This enables a number of further transformations in later
passes.  Both the input and output languages for this pass are <em>Lvar</em>,
defined in the files <code>lvar.ml[i]</code>.</p>
<p>This is a relatively simple pass to implement.  There are four cases:</p>
<ol>
<li>
<p>Forms with no subexpressions and no variables.  These pass through
    unchanged.</p>
</li>
<li>
<p>Forms with subexpressions but no variables.  You have to recurse
    on the subexpressions and build up a new expression.</p>
</li>
<li>
<p><code>Var</code> expressions. You need to change the variable to its new name,
    if there is one.
    For this, you will have to have a data structure
    which maps the old names to the new names.
    We recommend that you use the <code>VarMap</code> module
    (defined in the <code>Types</code> module <em>i.e.</em> <code>types.ml</code> and <code>types.mli</code>),
    which is an instance of the <code>Map</code> functor specialized for the
    <code>var</code> type.  (Note that <code>var</code> is just an alias for <code>string</code>.)
    A value of type <code>VarMap.t</code> is a map from variable names to some other
    type; in this case we map variable names to (new) variable names!</p>
<p>Note that the <code>uniquify_exp</code> function doesn't have a <code>VarMap.t</code>
argument, so you will need to write a helper function that does.
When a <code>Var</code> expression is encountered,
check to see if the map has a new name for the variable.
If it does, substitute the new name for the old one.
Otherwise, leave the name unchanged.
(This can happen with some global names.)</p>
</li>
<li>
<p><code>Let</code> expressions.
    When these are encountered,
    you have to generate a new name from the binding name
    of the <code>let</code> expression.
    In the expression <code>(let (x 10) (+ x x))</code>, for instance,
    <code>x</code> is the binding name.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In compiler-speak, generated names that are different
from all other names are called "fresh" names.</p>
</div>
<p>To generate the new name, call the <code>fresh</code> function
(defined in the file)
with the current name and a separator as the arguments.
Use <code>.</code> as the separator, so <code>x</code> might become <em>e.g.</em> <code>x.1</code>.
Note that the <code>fresh</code> function has an internal counter,
so the next time it's called with the name <code>x</code>
it will return <code>x.2</code>, <em>etc.</em></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is imperative programming,
and the fact that we don't have to jump through any hoops to do it
(as we would, say, in Haskell)
is one reason why OCaml is a convenient language
for writing a compiler.
(Despite this, Haskell is also a great language
for writing compilers!)</p>
</div>
<p>The <code>fresh</code> function is just an alias for the function <code>Utils.gensym</code>
from the <code>Utils</code> module in the <code>support</code> library.  Feel free to
look at the code for this function if you're interested.  This function
also uses OCaml's labelled arguments feature, which we didn't use in CS 4.
A good reference for labelled arguments is
<a href="https://v2.ocaml.org/manual/lablexamples.html">here</a>.</p>
<p>When you generate a fresh name for a binding name, you also have to
add it to the map for the body expression of the <code>let</code>, but
<em>not</em> for the binding expression of the <code>let</code>
(since the new name is not in effect for that expression).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We <strong>very strongly recommend against</strong> using hash tables
for the map datatype.
Hash tables are imperative, and it's much too easy
to add something to a hash table
that will persist longer than you want it to.
In this case, an immutable datatype like <code>VarMap.t</code> is the way to go:
when you add something to it, you get a new map,
and you can use the new or old maps as you see fit.</p>
</div>
</li>
</ol>
<p>You should be able to implement this pass in about 50 lines of code
(or less).</p>
<h2 id="remove-complex-operands">Remove complex operands</h2>
<p>[File: <code>remove_complex.ml</code>]</p>
<p>The purpose of this pass is simply to make sure
that the operands of arithmetic operations are "simple" <em>i.e.</em>
are not subexpressions but "atomic" expressions like integers or variables.
The input language to this pass is <em>Lvar</em> and the output language is
<em>Lvar_mon</em>, which is defined in the files <code>lvar_mon.ml[i]</code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Terminology</strong>: integer literal and variable expressions are <em>simple</em>
or <em>atomic</em> expressions.  Any other expression is <em>complex</em>.</p>
</div>
<p>The name <em>Lvar_mon</em>
refers to the fact that the language is in <em>monadic normal form</em>,
the details of which do not concern us here.</p>
<p>We define an "atom" datatype in <code>lvar_mon.mli</code> as follows:</p>
<div class="language-ocaml highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">type</span> <span class="n">atm</span> <span class="o">=</span> <span class="nc">Int</span> <span class="k">of</span> <span class="kt">int</span> <span class="o">|</span> <span class="nc">Var</span> <span class="k">of</span> <span class="n">var</span>
</span></code></pre></div>
<p>and then use it in the expression datatype:</p>
<div class="language-ocaml highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">type</span> <span class="n">exp</span> <span class="o">=</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>  <span class="o">|</span> <span class="nc">Atm</span>    <span class="k">of</span> <span class="n">atm</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>  <span class="o">|</span> <span class="nc">Read</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>  <span class="o">|</span> <span class="nc">Negate</span> <span class="k">of</span> <span class="n">atm</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>  <span class="o">|</span> <span class="nc">Add</span>    <span class="k">of</span> <span class="n">atm</span> <span class="o">*</span> <span class="n">atm</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>  <span class="o">|</span> <span class="nc">Sub</span>    <span class="k">of</span> <span class="n">atm</span> <span class="o">*</span> <span class="n">atm</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>  <span class="o">|</span> <span class="nc">Let</span>    <span class="k">of</span> <span class="n">var</span> <span class="o">*</span> <span class="n">exp</span> <span class="o">*</span> <span class="n">exp</span>
</span></code></pre></div>
<p>The basic thing that has to happen in this pass
is that non-atomic subexpressions of arithmetic forms
(<code>Add</code>, <code>Sub</code>, and <code>Negate</code>)
have to be transformed into <code>let</code> expressions
which bind variable(s) to the complex subexpression(s).
So it's something like this:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>Negate &lt;complex exp&gt;
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>--&gt; Let (&quot;$tmp&quot;, &lt;complex exp&gt;, Negate (Var &quot;$tmp&quot;)
</span></code></pre></div>
<p>Clearly, you will need to introduce <code>let</code> expressions wherever
there are arithmetic expressions with complex subexpressions.</p>
<p>On the other hand, expressions that are already atomic should stay
the way they are:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>Negate (Int 10) --&gt; Negate (Int 10)
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>Negate (Var &quot;x&quot;) --&gt; Negate (Var &quot;x&quot;)
</span></code></pre></div>
<p>Don't do this:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>Negate (Int 10)
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>--&gt; Let (&quot;$tmp&quot;, Int 10, Negate (Var &quot;$tmp&quot;))
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>Negate (Var &quot;x&quot;)
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>--&gt; Let (&quot;$tmp&quot;, Var &quot;x&quot;, Negate (Var &quot;$tmp&quot;))
</span></code></pre></div>
<p>This is called "generating unnecessary temporaries".
Although this doesn't yield incorrect code, it does yield inefficient code.
(Why do you think that is?)</p>
<p>The key function to write here is <code>rco_atom</code>.
This takes an expression which needs to become atomic
(like a subexpression of <code>Add</code>, say),
and returns both the atomic expression
and a list of (name, expression) bindings.
In many cases you'll need to generate temporary names;
the <code>gen_temp_name</code> function is provided to you for this purpose.</p>
<p><code>rco_atom</code> is called from the <code>rco_exp</code> function,
and the <code>rco_exp</code> function has to take the (name, expression) pairs
and convert them into <code>let</code> expressions.
(We wrote a helper function to do this;
you will probably want to do the same.)</p>
<p>One last thing about this pass:
the immediate subexpressions of a <code>let</code> expression (both of them)
do <em>not</em> need to be atomic, so don't try to make them atomic!
That means that you can have arbitrarily nested <code>let</code> expressions.
If this bothers you, don't worry: we'll fix it in the next pass!</p>
<h2 id="explicate-control">Explicate control</h2>
<p>[File: <code>explicate_control.ml</code>]</p>
<p>The purpose of this pass is to "flatten" the code representation
into a sequence of assignment statements followed by a "return" statement.
The <code>let</code> statements are gone, replaced by assignments.
There is no more nesting of expressions,
unless you consider the sequence of assignments "nesting".</p>
<p>The input language to the pass is <em>Lvar_mon</em>
and the output language is <em>Cvar</em>,
defined in the files <code>cvar.ml[i]</code>.
The name <em>Cvar</em> was chosen because the straight-line nature of the code
is very similar to the way code is represented in a C language program.</p>
<p>The source code consists of five functions:</p>
<ul>
<li><code>convert_atom</code></li>
<li><code>convert_exp</code></li>
<li><code>explicate_assign</code></li>
<li><code>explicate_tail</code></li>
<li><code>explicate_control</code></li>
</ul>
<p><code>explicate_control</code> is supplied for you.
<code>convert_atom</code> and <code>convert_exp</code> are straightforward.
<code>explicate_tail</code> converts an expression in tail position,
while <code>explicate_assign</code> converts an assignment statement
followed by an already-converted tail expression.</p>
<p>In both <code>explicate_tail</code> and <code>explicate_assign</code>,
the only (slightly) tricky case is the <code>let</code> case.
Hint: <code>explicate_tail</code> has to call <code>explicate_assign</code>.
The total code is considerably less than 100 lines.</p>
<h2 id="select-instructions">Select instructions</h2>
<p>[File: <code>select_instructions.ml</code>]</p>
<p>This is the first of several passes collectively called the "back end".
Their job is to convert the code into x86-64 assembly language.
There are three intermediate languages specific to these passes:</p>
<ol>
<li>
<p><em>x86var</em> (<code>x86var.ml[i]</code>)</p>
<p>This language mixes assembly language instructions with variables.</p>
</li>
<li>
<p><em>x86int</em> (<code>x86int.ml[i]</code>)</p>
<p>This language gets rid of variables.  Variables are represented by
stack locations (in this assignment) and by a combination of
stack locations and registers (in later assignments).</p>
</li>
<li>
<p><em>x86asm</em> (<code>x86asm.ml[i]</code>)</p>
<p>This language adds extra code (the "prelude" and "conclusion")
necessary to make the entire program into a single unit that
can be compiled into a full executable program.<sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup></p>
</li>
</ol>
<p>After <em>x86asm</em>, actual assembly code is trivially generated by the
"print assembly" pass (<code>print_asm.ml[i]</code>).</p>
<p>In the "select instructions" pass,
code is converted from the <em>Cvar</em> language to the <em>x86var</em> language.</p>
<p>The <code>select_instructions.ml</code> file is mostly empty.  You have to
implement the <code>convert_lt</code> function, which converts a (label, tail)
pair (<em>Cvar</em> language) into a (label, block) pair (<em>x86var</em> language).
The labels don't change, so essentially you are changing a Cvar tails
into <em>x86var</em> blocks (lists of instructions).  You will want to write
helper functions to do this.  (We put ours outside of the <code>convert_lt</code>
function; you can do it any way you like.)</p>
<p>Quoting from the textbook:</p>
<blockquote>
<p>We recommend implementing the <code>select_instructions</code> [pass]
with three auxiliary functions,
one for each of the nonterminals of <em>Cvar</em>:
<code>atm</code>, <code>stmt</code>, and <code>tail</code>.</p>
</blockquote>
<p>The textbook has a good description of how to convert <em>Cvar</em>
tails/statements/expressions/atoms into <em>x86var</em> instructions.
Note that a single <em>Cvar</em> expression can yield more than one
<em>x86var</em> instruction.</p>
<p>The <code>Return</code> instruction requires special treatment.
You don't actually generate a <code>Retq</code> instruction
since this doesn't actually represent returning from a function
(we'll see why in the "prelude and conclusion" pass below).
Instead, you have to do the following:</p>
<ol>
<li>
<p>Convert the expression which is the argument of the <code>Return</code>
   and move that result into the <code>Rax</code> register
   (this may take one or two instructions, depending on the expression).
   Note that a function call (which can only be <code>Read</code> here)
   will automatically return its result into the <code>Rax</code> register.</p>
</li>
<li>
<p>Emit a <code>Jmp</code> instruction to a label called <code>conclusion</code>.</p>
</li>
</ol>
<p>There is one other peculiarity of this pass that isn't in the book. We've
provided a function called <code>fix_label</code> which should be used whenever calling
an external function.  In this case, the only external function is
<code>read_int</code>, which is what a <code>Read</code> instruction in Cvar should compile to.
So <code>Read</code> becomes <code>Callq (Label "read_int", 0)</code>.  (The <code>0</code> is the
function arity <em>i.e.</em> the number of arguments the function takes.) However,
different operating systems have different conventions for labels. In
particular, MacOS requires that function labels have an initial underscore, so
you should compile this into <code>Call1 (Label "_read_int", 0)</code> if you're on a
Mac.  To make the compiler more independent of the OS it's being run on, we've
added the <code>fix_label</code> function, which checks to see if the OS is "MacOS", and
if so, prepends the underscore to the label.  So instead of converting <code>Read</code>
to <code>Callq (Label "read_int", 0)</code>, convert it to <code>Callq (Label (fix_label
"read_int"), 0)</code>.<sup id="fnref:3"><a class="footnote-ref" href="#fn:3">3</a></sup></p>
<p>Also, chapter 2 of the textbook (section 2.7) describes ways
of optimizing certain instructions.
For example, an <code>Add</code> expression/assignment of the form
<code>v = (+ a1 a2)</code> can be compiled into two instructions,
but if <code>a2</code> is the same as <code>v</code> (<em>i.e.</em> <code>v = (+ a1 v)</code>),
it could be compiled into a single <code>addq</code> instruction.
This is all well and good,
but because of the "uniquify" pass earlier in the compiler,
this will never happen because <code>v = (+ a1 v)</code> would actually
become <code>v1 = (+ a1 v2)</code>.
Therefore, you should <em>not</em> write the code
to optimize instructions in this way.
(This will also reduce the amount of code you need to write.)
There is no reason to add code for situations that can't occur
and can't be tested.
However, you should definitely use as few instructions as possible
(in this case, two instructions).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In later compilers, we will eventually add these optimizations back,
because once the language has been sufficiently expanded,
these situations can occur.</p>
</div>
<h2 id="assign-homes">Assign homes</h2>
<p>[File: <code>assign_homes.ml</code>]</p>
<p>The purpose of this pass is to convert variable names into stack locations.
Note that in this compiler, we are not storing variables in registers.
(In all the later compilers, we will be.)  Therefore, this pass will only
exist in this compiler; in later compilers, it will be replaced by several
register allocation passes.  Fortunately, assigning variables to stack slots
is straightforward.</p>
<p>Although this pass converts <em>x86var</em> programs to <em>x86var</em> programs,
the resulting programs will not use variables.
(We will get rid of variables altogether in the x86int language.)
However, the <code>info</code> field of the programs will change;
after the "select instructions" pass the info field is <code>info1</code>,
which stores type information for all variables;
after "assign homes" it's <code>info2</code>,
which only stores the stack space used.</p>
<p>Variables placed on the stack are identified by their position in memory
relative to the "base pointer".   This is a memory location which is stored in
a special register called <code>rbp</code> (often written <code>%rbp</code>, though in the OCaml
code we refer to it as <code>Rbp</code>).<sup id="fnref:4"><a class="footnote-ref" href="#fn:4">4</a></sup>
The base pointer represents the start of the stack
used for a particular function.
Variables stored on the stack are identified relative to the base pointer.
Stack variables are placed in memory below the base pointer
(we say that the stack "grows downwards").
Variables are 8 bytes in size (64 bits),
so the first variable will be stored 8 bytes below the base pointer.
In assembly language, this is written as <code>-8(%rbp)</code>;
in the OCaml code we write it as <code>Deref (Rbp, -8)</code>.
The next stack location will be <code>-16(%rbp)</code>, and so on.
The space used for all the stack variables is known as the "stack frame".
One curious requirement is that the total amount of space
used for the stack frame must be a multiple of 16 bytes,
so even if you only need one stack variable (8 bytes),
you have to reserve 16 bytes.</p>
<p>Here's what you need to do in this pass:</p>
<ol>
<li>
<p>Use the <code>info1</code> field to assign stack locations to all variables
   used in the program.  <code>info1</code> contains a list of all variables
   in the program as well as their types.
   (The types are all <code>Integer</code>, so that isn't relevant
   except that you need to know that all integers are 8 bytes long.)
   You should store the (variable name, stack location) pairs
   as an <code>int VarMap.t</code> (mapping names to their stack locations).
   You will also need to compute the total amount of stack space
   required.  Since this has to be aligned on a 16 byte boundary,
   we've provided a utility function called <code>align_16</code> in the
   <code>Utils</code> module of the <code>support</code> library.</p>
</li>
<li>
<p>Once this has been done, you need to go through all the instructions
   in the blocks and replace variables with their stack locations.
   If you encounter a variable which doesn't have an assigned stack location,
   signal an error (this shouldn't happen, but it's good to check).</p>
</li>
<li>
<p>Compute an <code>info2</code> field using the computed stack space,
   and reconstitute the program.</p>
</li>
</ol>
<h2 id="patch-instructions">Patch instructions</h2>
<p>[File: <code>patch_instructions.ml</code>]</p>
<p>In a perfect world, we would not need to do this pass.
However, the x86-64 instruction set is far from elegant,
and we have to deal with its restrictions.
One such restriction is that no instruction can have
two arguments where both arguments are memory references
(as opposed to (say) immediate values or registers).
If such instructions exist, they need to be "patched" (fixed)
so that the restriction is adhered to.</p>
<p>There are different ways of handling this,
but the textbook suggests a very simple strategy.
When you have an instruction that uses two stack locations,
convert it into two instructions using the <code>%rax</code> register (OCaml <code>Rax</code>)
as an intermediary.
There are only three instructions in this compiler where this can happen:
<code>addq</code>, <code>subq</code>, and <code>movq</code>.
The <code>movq</code> case is the simplest.
Change:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>movq -8(%rbp), -16(%rbp)
</span></code></pre></div>
<p>to two instructions:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>movq -8(%rbp), %rax
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>movq %rax, -16(%rbp)
</span></code></pre></div>
<p>This doesn't violate the restriction.  The <code>addq</code> and <code>subq</code> cases
are similar but slightly trickier.</p>
<p>What you need to do is to go through all instructions,
determine if an instruction needs to be patched,
and patch it in those cases.
Don't match instructions that don't need to be patched!
For instance, don't change:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>movq $42, -8(%rbp)
</span></code></pre></div>
<p>into this:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>movq $42, %rax
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>movq %rax, -8(%rbp)
</span></code></pre></div>
<p>because the instruction didn't need to be patched
(since there was only one memory reference).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code>$42</code> assembly language syntax means an immediate value;
in OCaml we write this as <code>Imm 42</code>.</p>
</div>
<p>Note also that this pass converts from the <em>x86var</em> language to the
<em>x86int</em> language, which doesn't have variables.
This means that there will be some trivial "boilerplate" conversions,
like converting an <code>Imm</code> constructor in one language
to the exact same constructor in the other language.
This is trivial but a bit tedious.
(It's the price we pay for having precise types.)</p>
<h2 id="prelude-and-conclusion">Prelude and conclusion</h2>
<p>[File: <code>prelude_conclusion.ml</code>]</p>
<p>This is the last pass you need to write.
The textbook also includes a partial evaluator pass as an optional
"challenge" pass; we won't be doing that.</p>
<p>This pass converts from the <em>x86int</em> language to the <em>x86asm</em> language,
which is basically x86-64 assembly language,
but in an S-expression representation.
The actual assembly language is generated by the "print assembly" pass,
which you don't have to write.</p>
<p>The purpose of this pass is to add extra code
to make a complete assembly language program.
The code that we have been generating so far
(whether we were aware of it or not)
is the body of the <code>main</code> function.
However, in order for this to be a proper function,
some code has to be added both before and after the code we've written.
The code that is executed before the code we've written
is called the "prelude",
and the code that comes after is called the "conclusion".
These don't have to come physically before or after our code,
since we have <code>jmp</code> instructions to transfer control.
Therefore, we put them after our code.</p>
<p>The code we've been working with is all in a single block
labelled <code>start</code>.
The code that comes before this is going to have to jump to this label,
and our code is going to have to eventually jump to the label
called <code>conclusion</code>.
The "prelude" is everything that comes before the jump to <code>start</code>
and the "conclusion" is everything that comes after the jump to
<code>conclusion</code>.</p>
<p>The <em>actual</em> beginning of execution is the label called <code>main</code>
(or <code>_main</code> if you're running on a Mac).
We also have to declare <code>main</code> to be a "global" name
(as all top-level functions have to be)
by using the <code>Global</code> instruction.
(This becomes <code>.globl</code> in the actual assembly code.)
This declaration has to come before the <code>main</code> label,
and it's the beginning of the prelude.</p>
<p>The prelude does the following:</p>
<ol>
<li>Declares <code>main</code> as a global name and defines the <code>main</code> label.</li>
<li>Saves the previous base pointer (in the <code>%rbp</code> register) to
   the stack (using a <code>pushq</code> instruction).</li>
<li>Saves the current stack pointer (in the <code>%rsp</code> register)
   into the base pointer register <code>%rbp</code>.</li>
<li>Reserves space for all the stack variables (a multiple of 16)
   by modifying the stack pointer <code>%rsp</code>.</li>
<li>Jumps to the <code>start</code> label.</li>
</ol>
<p>The conclusion does the following:</p>
<ol>
<li>Reclaims the stack space used in the code.</li>
<li>Restores the old base pointer using a <code>popq</code> instruction.</li>
<li>Returns from the <code>main</code> function with a <code>retq</code> instruction.</li>
</ol>
<p>This code is completely generic except for the stack space,
which is going to depend on how many variables are placed on the stack.
You can look at the examples in the <code>reference</code> directory to see
what the prelude and conclusion look like.
The code is easy to write,
although there are a number of trivial "boilerplate" conversions
because we are changing the datatype.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>The interpreters are not part of the compiler <em>per se</em>,
but they are used for testing.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Note that this language is not described in the book;
the book simply outputs assembly language as a string.&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>Aren't compilers fun?  You have to deal with all of this
arbitrary nonsense, because otherwise you can't generate working code.
That's the price you pay for doing something cool.&#160;<a class="footnote-backref" href="#fnref:3" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:4">
<p>Fun fact: There is no absolute requirement to use the <code>%rbp</code>
register to store the base pointer.  Many C compilers (<em>e.g.</em> <code>gcc</code>)
have an option to omit the base pointer entirely, which frees up
this register to be used to store regular variables.
This is a big deal for processors with very few registers
(like 32 bit x86 processors) but less important for us, since
x86-64 processors have 16 registers.&#160;<a class="footnote-backref" href="#fnref:4" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
</ol>
</div>





                
              </article>
            </div>
          
          
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../overview/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Overview" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Overview
              </div>
            </div>
          </a>
        
        
          
          <a href="../testing/" class="md-footer__link md-footer__link--next" aria-label="Next: Testing" rel="next">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Testing
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.copy", "navigation.footer", "navigation.top"], "search": "../../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.b425cdc4.min.js"></script>
      
        
          <script src="../../../js/mathjax.js"></script>
        
      
        
          <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        
      
        
          <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        
      
    
  </body>
</html>