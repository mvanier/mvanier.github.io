<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Debugging &mdash; The CS 131 book</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/sphinx_highlight.js"></script>
        <script src="../../../../_static/clipboard.min.js"></script>
        <script src="../../../../_static/copybutton.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Part A: Finishing and extending uScheme : parsing" href="partA_extending1.html" />
    <link rel="prev" title="Preamble" href="Preamble.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            The CS 131 book, Spring 2023
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../Introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Software.html">Installing the course software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Lectures.html">Lectures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../admin/index.html">Administrative information</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Assignments</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../1/index.html">Assignment 1: The <em>Imp</em> language</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Assignment 2: The <em>uScheme</em> language</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="Preamble.html">Preamble</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Debugging</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#about-repls">About REPLs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-the-uscheme-repl">Using the <em>uScheme</em> REPL</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-the-ocaml-repl">Using the OCaml REPL</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-ocaml-debugger">The OCaml debugger</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="partA_extending1.html">Part A: Finishing and extending <em>uScheme</em> : parsing</a></li>
<li class="toctree-l3"><a class="reference internal" href="partB_extending2.html">Part B: Finishing and extending <em>uScheme</em> : evaluation</a></li>
<li class="toctree-l3"><a class="reference internal" href="partC_programming.html">Part C: Programming in extended <em>uScheme</em></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../3/index.html">Assignment 3: The <em>uScheme+</em> language</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">The CS 131 book, Spring 2023</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Assignments</a></li>
          <li class="breadcrumb-item"><a href="../index.html">Assignment 2: The <em>uScheme</em> language</a></li>
      <li class="breadcrumb-item active">Debugging</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="debugging">
<h1>Debugging<a class="headerlink" href="#debugging" title="Permalink to this heading"></a></h1>
<p>Debugging a multi-file OCaml project can be challenging.  Here are some tips
and tricks to make it less painful.</p>
<section id="about-repls">
<h2>About REPLs<a class="headerlink" href="#about-repls" title="Permalink to this heading"></a></h2>
<p>The term “REPL” is an acronym meaning
<span class="raw-html">"<b>R</b>ead-<b>E</b>val-<b>P</b>rint-<b>L</b>oop"</span>.
It’s a fancy name for an interactive interpreter.
Many languages have REPLs, such as Python, Ruby,
almost all Scheme and Lisp dialects, OCaml, and Haskell.
Other languages like C, C++ and Go do not.
(Java didn’t originally, but now has the <code class="docutils literal notranslate"><span class="pre">jshell</span></code> REPL.)</p>
<p>The reason that REPLs are popular is that they are a big help
for debugging, for writing quick throwaway code to explore an
unfamiliar library, and as a way to interactively prototype a solution.
Here, we’re going to concentrate on using REPLs for debugging.</p>
<p>Each project in CS 131 has <em>two</em> REPLs:
the OCaml REPL and the REPL for the language being implemented.
Each of them has different uses, which we’ll describe below.</p>
</section>
<section id="using-the-uscheme-repl">
<h2>Using the <em>uScheme</em> REPL<a class="headerlink" href="#using-the-uscheme-repl" title="Permalink to this heading"></a></h2>
<p>Running <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code> will work fine if all of the tests pass,
but if a test fails, you have to dig deeper.
Since each of the languages we will implement provides a REPL,
it makes sense to use it to help understand when a test fails.</p>
<p>The first thing to do when a test fails is to determine which test file
contained the failing test.
The output from <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code> will tell you this.</p>
<p>The second thing is to isolate which test in the file failed.
For most test failures
(where the output of some code isn’t what was expected),
the output of <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code> will also tell you this.
However, there are cases when <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code>
doesn’t give you enough information.
An example would be when the code in a <code class="docutils literal notranslate"><span class="pre">check-expect</span></code> test
loops forever.
You will be told that a test in a particular file timed out,
but not which test timed out.
What do you do then?</p>
<p>Fundamentally, all that <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code> is doing is running the
<em>uScheme</em> interpreter on all of the test files,
and collecting and displaying the output if a test fails.
You can also manually run a test file.  For instance,
if a test in <code class="docutils literal notranslate"><span class="pre">tests/lists.scm</span></code> fails, you can type:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ ./uscheme tests/lists.scm
</pre></div>
</div>
<p>and look at the output.  At this point, your main goal is to find
the test that failed.</p>
<p>The output from tests run interactively is more verbose than the output
from just running <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code>.  For instance, passing tests will
also print the location of the test that passed.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is a new feature!  If you really hate it, you can disable it
by setting the <code class="docutils literal notranslate"><span class="pre">verbose_tests</span></code> variable in <code class="docutils literal notranslate"><span class="pre">eval.ml</span></code> to <code class="docutils literal notranslate"><span class="pre">false</span></code>.</p>
</div>
<p>Let’s define a simple test file called <code class="docutils literal notranslate"><span class="pre">foo.scm</span></code> and put it in the
<code class="docutils literal notranslate"><span class="pre">tests</span></code> directory:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>;; foo.scm
(check-expect (+ 1 1) 2)
(define loop () (loop))
(check-expect (loop) 0)
(check-expect (* 2 3) 6)
</pre></div>
</div>
<p>Looking at this, you can see that the <code class="docutils literal notranslate"><span class="pre">loop</span></code> function will loop indefinitely.
If you run this file, here’s what you see:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ ./uscheme tests/foo.scm
check-expect test passed (tests/foo.scm: 2:1-24)
</pre></div>
</div>
<p>and then it will hang (loop forever).
The test output at least tells you that the last passing test was at line 2.
So you should look for the test following the test on line 2,
which is the one that calls <code class="docutils literal notranslate"><span class="pre">(loop)</span></code> and thus loops forever.
(Of course, most examples will be more complicated than this.)</p>
<p>Once you have located the test that fails, try running it interactively
in the <em>uScheme</em> REPL:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ ./uscheme
&gt;&gt;&gt; (define loop () (loop))
&gt;&gt;&gt; (loop)  ; runs forever
</pre></div>
</div>
<p>This allows you to confirm what the problem is.
Now you’ve narrowed down the problem significantly.</p>
</section>
<section id="using-the-ocaml-repl">
<h2>Using the OCaml REPL<a class="headerlink" href="#using-the-ocaml-repl" title="Permalink to this heading"></a></h2>
<p>Often a bug won’t be in the code you write in <em>uScheme</em>
but in the OCaml code you write to implement the interpreter.
Finding these bugs can be tricky.
For simple OCaml programs (like most of the ones in CS 4),
you can simply load files into the OCaml REPL (<code class="docutils literal notranslate"><span class="pre">utop</span></code>)
using the <code class="docutils literal notranslate"><span class="pre">#use</span></code> directive:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="o">#</span> <span class="o">#</span><span class="n">use</span> <span class="s2">&quot;lab3.ml&quot;</span><span class="o">;;</span>
</pre></div>
</div>
<p>and then test the functions interactively
to see if they are doing the right thing.
But with a large multi-file program like the interpreters in this assignment
(and in the rest of the course), it’s not as easy.</p>
<p>Starting with this assignment, we’ve added a <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> target that will
allow you to open an OCaml REPL (using <code class="docutils literal notranslate"><span class="pre">utop</span></code>) “pre-loaded” with the
code from the assignment.  The steps are:</p>
<ol class="arabic simple">
<li><p>Compile the code (type <code class="docutils literal notranslate"><span class="pre">make</span></code>).</p></li>
<li><p>Type <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">repl</span></code>.  That will start up <code class="docutils literal notranslate"><span class="pre">utop</span></code> with the
code for the assignment pre-loaded.</p></li>
<li><p>Inside <code class="docutils literal notranslate"><span class="pre">utop</span></code>, experiment with the functions that you think
aren’t working correctly.</p></li>
</ol>
<p>Here’s an example to show how this works:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ make
$ make repl
# open Env;;
# string_of_value (IntVal 10);;
- : string = &quot;10&quot;
</pre></div>
</div>
<p>Technically, we could have omitted the <code class="docutils literal notranslate"><span class="pre">open</span> <span class="pre">Env;;</span></code> line and typed
<code class="docutils literal notranslate"><span class="pre">Env.string_of_value</span> <span class="pre">(IntVal</span> <span class="pre">10);;</span></code>, but it’s nice not to have to
qualify all names from a module.</p>
<p>Using the REPL is useful when you think a specific function
is giving the wrong answer for a specific set of inputs.
It’s not always easy to use, though,
since sometimes it’s hard to create the necessary inputs.
But it will make debugging easier in many cases.</p>
</section>
<section id="the-ocaml-debugger">
<h2>The OCaml debugger<a class="headerlink" href="#the-ocaml-debugger" title="Permalink to this heading"></a></h2>
<p>The most extreme approach is to use the <a class="reference external" href="https://v2.ocaml.org/manual/debugger.html">OCaml debugger</a>.
This will allow you to step through your code with microscopic precision.</p>
<p>To run the OCaml debugger on your code, compile it normally and then
just call it with the <code class="docutils literal notranslate"><span class="pre">ocamldebug</span></code> program:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ make
$ ocamldebug ./uscheme
        OCaml Debugger version 4.14.1

(ocd)
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">(ocd)</span></code> is the OCamldebug prompt. To run the interpreter, type <code class="docutils literal notranslate"><span class="pre">run</span></code>:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>(ocd) run
&gt;&gt;&gt; (+ 1 2)
3
</pre></div>
</div>
<p>Now, if there is code that crashes the interpreter,
you can enter it and the debugger will halt on the crash.
You can set breakpoints, move back in time (!)
and do all the things you can usually do in debuggers.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Line-by-line debugging, which you’re probably used to
from imperative languages,
doesn’t work in functional languages like OCaml.
Instead, the debugger works on “events”,
which are “interesting” locations in the source code.
This means that the learning curve for using the debugger
is greater than that in an imperative language.
This is one reason why few OCaml programmers use the debugger.
(The others are the excellent OCaml REPL and the type checker,
which catches most simple bugs.)
Nevertheless, for really tricky bugs, it’s good to have the
debugger available.</p>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Preamble.html" class="btn btn-neutral float-left" title="Preamble" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="partA_extending1.html" class="btn btn-neutral float-right" title="Part A: Finishing and extending uScheme : parsing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Michael C. Vanier. All rights reserved.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>