<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Part B: Finishing and extending uScheme : evaluation &mdash; The CS 131 book</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/sphinx_highlight.js"></script>
        <script src="../../../../_static/clipboard.min.js"></script>
        <script src="../../../../_static/copybutton.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Part C: Programming in extended uScheme" href="partC_programming.html" />
    <link rel="prev" title="Part A: Finishing and extending uScheme : parsing" href="partA_extending1.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            The CS 131 book, Spring 2023
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../Introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Software.html">Installing the course software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Lectures.html">Lectures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../admin/index.html">Administrative information</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Assignments</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../1/index.html">Assignment 1: The <em>Imp</em> language</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Assignment 2: The <em>uScheme</em> language</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="Preamble.html">Preamble</a></li>
<li class="toctree-l3"><a class="reference internal" href="Debugging.html">Debugging</a></li>
<li class="toctree-l3"><a class="reference internal" href="partA_extending1.html">Part A: Finishing and extending <em>uScheme</em> : parsing</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Part B: Finishing and extending <em>uScheme</em> : evaluation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#literals">1. Literals</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-primitive-function">2. The <code class="docutils literal notranslate"><span class="pre">=</span></code> primitive function</a></li>
<li class="toctree-l4"><a class="reference internal" href="#extending-pairs">3. Extending pairs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-equal-basis-function">4. The <code class="docutils literal notranslate"><span class="pre">equal?</span></code> basis function</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-valrec-definition-form">5. The <code class="docutils literal notranslate"><span class="pre">valrec</span></code> definition form</a></li>
<li class="toctree-l4"><a class="reference internal" href="#functions-with-variable-numbers-of-arguments">6. Functions with variable numbers of arguments</a></li>
<li class="toctree-l4"><a class="reference internal" href="#other-modifications">7. Other modifications</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="partC_programming.html">Part C: Programming in extended <em>uScheme</em></a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">The CS 131 book, Spring 2023</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Assignments</a></li>
          <li class="breadcrumb-item"><a href="../index.html">Assignment 2: The <em>uScheme</em> language</a></li>
      <li class="breadcrumb-item active">Part B: Finishing and extending <em>uScheme</em> : evaluation</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="part-b-finishing-and-extending-uscheme-evaluation">
<h1>Part B: Finishing and extending <em>uScheme</em> : evaluation<a class="headerlink" href="#part-b-finishing-and-extending-uscheme-evaluation" title="Permalink to this heading"></a></h1>
<p>Now that we’ve dealt with the parsing issues,
we can concentrate on making the entire extended version of <em>uScheme</em> work.</p>
<section id="literals">
<h2>1. Literals<a class="headerlink" href="#literals" title="Permalink to this heading"></a></h2>
<p>Edit the literal-handling code in <code class="docutils literal notranslate"><span class="pre">eval.ml</span></code> to work with the new literal
type.</p>
</section>
<section id="the-primitive-function">
<h2>2. The <code class="docutils literal notranslate"><span class="pre">=</span></code> primitive function<a class="headerlink" href="#the-primitive-function" title="Permalink to this heading"></a></h2>
<p>Make the <code class="docutils literal notranslate"><span class="pre">=</span></code> primitive function (defined in <code class="docutils literal notranslate"><span class="pre">basis.ml</span></code>)
work with unit values and symbols as well as all other atomic values.
(It doesn’t work for compound data types like pairs;
the <code class="docutils literal notranslate"><span class="pre">equal</span></code> basis function takes care of that.)
Note that the function <code class="docutils literal notranslate"><span class="pre">prim_eq</span></code> is the one that defines the <code class="docutils literal notranslate"><span class="pre">=</span></code> primitive.</p>
<p>The only file you need to change for this problem is <code class="docutils literal notranslate"><span class="pre">basis.ml</span></code>.</p>
<div class="example admonition">
<p class="admonition-title">Examples</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; (= 0 0)
#t
&gt;&gt;&gt; (= 0 1)
#f
&gt;&gt;&gt; (= #u #u)
#t
&gt;&gt;&gt; (= #f #f)
#t
&gt;&gt;&gt; (= #f #t)
#f
&gt;&gt;&gt; (= &#39;foo &#39;foo)
#t
&gt;&gt;&gt; (= &#39;foo &#39;bar)
#f
</pre></div>
</div>
</div>
</section>
<section id="extending-pairs">
<h2>3. Extending pairs<a class="headerlink" href="#extending-pairs" title="Permalink to this heading"></a></h2>
<p>Change the representation of pairs in <code class="docutils literal notranslate"><span class="pre">env.ml</span></code>’s <code class="docutils literal notranslate"><span class="pre">value</span></code> type
to be pairs of <code class="docutils literal notranslate"><span class="pre">value</span> <span class="pre">ref</span></code>s instead of pairs of <code class="docutils literal notranslate"><span class="pre">value</span></code>s.
In other words, make pairs mutable.
Once you have done this,
change the definition of the pair primitives <code class="docutils literal notranslate"><span class="pre">cons</span></code>, <code class="docutils literal notranslate"><span class="pre">car</span></code>, and <code class="docutils literal notranslate"><span class="pre">cdr</span></code>
(in <code class="docutils literal notranslate"><span class="pre">basis.ml</span></code>) to use the new representation.
Add two new primitives to <code class="docutils literal notranslate"><span class="pre">basis.ml</span></code>: <code class="docutils literal notranslate"><span class="pre">set-car</span></code> and <code class="docutils literal notranslate"><span class="pre">set-cdr</span></code>.
They both take two arguments: a <code class="docutils literal notranslate"><span class="pre">cons</span></code> pair and a value.
<code class="docutils literal notranslate"><span class="pre">set-car</span></code> changes the <code class="docutils literal notranslate"><span class="pre">car</span></code> of the pair to the value,
while <code class="docutils literal notranslate"><span class="pre">set-cdr</span></code> changes the <code class="docutils literal notranslate"><span class="pre">cdr</span></code>.
Both primitives return unit (<code class="docutils literal notranslate"><span class="pre">#u</span></code>) values.</p>
<p>Make whatever other changes may be necessary after making this change.
The compiler will helpfully point out all places where the old pair
definition is no longer valid. (Strongly statically-typed languages like
OCaml are really good for refactorings of this sort.)</p>
<p>The files you need to change for this problem are <code class="docutils literal notranslate"><span class="pre">env.ml</span></code>,
<code class="docutils literal notranslate"><span class="pre">env.mli</span></code>, <code class="docutils literal notranslate"><span class="pre">quote.ml</span></code>, and <code class="docutils literal notranslate"><span class="pre">basis.ml</span></code>. Look at the way primitive
functions are defined in <code class="docutils literal notranslate"><span class="pre">basis.ml</span></code> to understand how to define a new
one.</p>
<div class="example admonition">
<p class="admonition-title">Examples</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; (val p (cons 1 2))
val p = &#39;(1 . 2)
&gt;&gt;&gt; (car p)
1
&gt;&gt;&gt; (cdr p)
2
&gt;&gt;&gt; (set-car p 42)
&gt;&gt;&gt; (car p)
42
&gt;&gt;&gt; p
&#39;(42 . 2)
&gt;&gt;&gt; (set-cdr p 101)
&gt;&gt;&gt; (cdr p)
101
&gt;&gt;&gt; p
&#39;(42 . 101)
</pre></div>
</div>
</div>
</section>
<section id="the-equal-basis-function">
<h2>4. The <code class="docutils literal notranslate"><span class="pre">equal?</span></code> basis function<a class="headerlink" href="#the-equal-basis-function" title="Permalink to this heading"></a></h2>
<p>There is a function called <code class="docutils literal notranslate"><span class="pre">equal?</span></code> in <code class="docutils literal notranslate"><span class="pre">basis.ml</span></code>
which is commented out (indicated by a <code class="docutils literal notranslate"><span class="pre">TODO</span></code> comment).
Remove the <code class="docutils literal notranslate"><span class="pre">TODO</span></code> comment and uncomment the function.</p>
</section>
<section id="the-valrec-definition-form">
<h2>5. The <code class="docutils literal notranslate"><span class="pre">valrec</span></code> definition form<a class="headerlink" href="#the-valrec-definition-form" title="Permalink to this heading"></a></h2>
<p>In part A you implemented the syntax for the <code class="docutils literal notranslate"><span class="pre">valrec</span></code> definition form.
This form is used to define mutually-recursive functions at the top level.
It looks like this:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>(valrec
  [f ...]
  [g ...])
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">...</span></code> parts are normally <code class="docutils literal notranslate"><span class="pre">lambda</span></code> expressions. The semantics are
similar to <code class="docutils literal notranslate"><span class="pre">letrec</span></code>:</p>
<ul class="simple">
<li><p>Extend the environment with new bindings of all the names to be
defined in the <code class="docutils literal notranslate"><span class="pre">valrec</span></code> (here, just <code class="docutils literal notranslate"><span class="pre">f</span></code> and <code class="docutils literal notranslate"><span class="pre">g</span></code>) to unspecified
values.</p></li>
<li><p>Evaluate the expressions (the <code class="docutils literal notranslate"><span class="pre">...</span></code> parts) in the context of the
extended environment.</p></li>
<li><p>Rebind the defined names to the values of the corresponding
expressions.</p></li>
</ul>
<p>Also, an empty <code class="docutils literal notranslate"><span class="pre">valrec</span></code> form (<em>i.e.</em> <code class="docutils literal notranslate"><span class="pre">(valrec)</span></code>) should be a syntax
error.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The main difference between <code class="docutils literal notranslate"><span class="pre">valrec</span></code> and <code class="docutils literal notranslate"><span class="pre">letrec</span></code>
is that <code class="docutils literal notranslate"><span class="pre">valrec</span></code> has no body and the bindings are visible
in the rest of the file.</p>
</div>
<p>Implement the <code class="docutils literal notranslate"><span class="pre">valrec</span></code> semantics in the evaluator code in <code class="docutils literal notranslate"><span class="pre">eval.ml</span></code>
(in the function <code class="docutils literal notranslate"><span class="pre">eval_def</span></code>).</p>
<p>Once this is done, you’ll be able to define mutually-recursive functions
at the top level easily:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>(valrec
  [even? (lambda (n) (if (= n 0) #t (odd? (- n 1))))]
  [odd? (lambda (n) (if (= n 0) #f (even? (- n 1))))])
</pre></div>
</div>
<p>When a <code class="docutils literal notranslate"><span class="pre">valrec</span></code> form is entered at the REPL,
it needs to be evaluated and then the names bound
should be printed out along with their values,
just like is done with a <code class="docutils literal notranslate"><span class="pre">val</span></code> expression.
Extend the REPL printing code in <code class="docutils literal notranslate"><span class="pre">uscheme.ml</span></code>
(specifically, the <code class="docutils literal notranslate"><span class="pre">repl_print</span></code> helper function) to achieve this.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">valrec</span></code> returns an environment and a <em>uScheme</em> value,
like all definition forms.
In this case, the <em>uScheme</em> value
needs to be able to contain multiple values
(for multiple mutually-recursive functions).
To do this, create a <em>uScheme</em> value
which is a <em>uScheme</em> list containing the values.
(Recall that a <em>uScheme</em> list
is made from pairs <code class="docutils literal notranslate"><span class="pre">cons</span></code>ed to each other
and ending in a <code class="docutils literal notranslate"><span class="pre">nil</span></code> value.)</p>
</div>
<p>The files you need to change for this problem
are <code class="docutils literal notranslate"><span class="pre">eval.ml</span></code> and <code class="docutils literal notranslate"><span class="pre">uscheme.ml</span></code>.</p>
</section>
<section id="functions-with-variable-numbers-of-arguments">
<h2>6. Functions with variable numbers of arguments<a class="headerlink" href="#functions-with-variable-numbers-of-arguments" title="Permalink to this heading"></a></h2>
<p>In part A, you implemented the syntax
for functions with variable numbers of arguments.
Here, you have to make them work.</p>
<p>At the level of the IR, there is only one form we have to worry about,
which is the (extended) <code class="docutils literal notranslate"><span class="pre">Lambda</span></code> form.  (Hooray for desugaring!)
Here is its definition:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>(* In ir.ml: *)

type expr =
  | ...
  | Lambda of loc * id list * id option * expr
  | ...
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">id</span> <span class="pre">list</span></code> represents the required arguments,
the <code class="docutils literal notranslate"><span class="pre">id</span> <span class="pre">option</span></code> represents the “rest” argument
for all the extra arguments after the required arguments
(if a rest argument is used and if there are any more arguments),
and the <code class="docutils literal notranslate"><span class="pre">expr</span></code> is the function body.</p>
<p>Here is what you need to do:</p>
<ol class="arabic">
<li><p>You need to add an extra error constructor
to the <code class="docutils literal notranslate"><span class="pre">uscheme_error_tag</span></code> type in <code class="docutils literal notranslate"><span class="pre">error.ml</span></code>:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>...
| CallErrorRest of int * int
...
</pre></div>
</div>
<p>This represents invalid calls to functions with rest arguments (<em>i.e.</em>
functions which can take arbitrary numbers of arguments). The first
<code class="docutils literal notranslate"><span class="pre">int</span></code> is the number of required arguments expected, while the
second is the number received. The number of received arguments must
be at least as large as the number of required arguments, or it’s an
error. Define an OCaml function <code class="docutils literal notranslate"><span class="pre">call_err_rest</span></code> in analogy to
<code class="docutils literal notranslate"><span class="pre">call_err</span></code> in <code class="docutils literal notranslate"><span class="pre">error.ml</span></code> and <code class="docutils literal notranslate"><span class="pre">error.mli</span></code> to make it easier to
signal errors of this kind, and then use it where appropriate
(<em>i.e.</em> in <code class="docutils literal notranslate"><span class="pre">eval.ml</span></code>).</p>
</li>
<li><p>Modify the <code class="docutils literal notranslate"><span class="pre">value</span></code> type definition in <code class="docutils literal notranslate"><span class="pre">env.ml</span></code> and <code class="docutils literal notranslate"><span class="pre">env.mli</span></code>;
specifically, change the <code class="docutils literal notranslate"><span class="pre">UserFuncVal</span></code> constructor to this:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>type env = ...
and value =
  | ...
  | UserFuncVal of Ast.id list * Ast.id option * Ir.expr * env
  | ...
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Ast.id</span> <span class="pre">option</span></code> field is <code class="docutils literal notranslate"><span class="pre">None</span></code> if the user function
doesn’t have a “rest” argument for non-required arguments, and it’s
<code class="docutils literal notranslate"><span class="pre">Some</span> <span class="pre">&lt;name&gt;</span></code> if it does.</p>
</li>
<li><p>Extend the evaluator code in <code class="docutils literal notranslate"><span class="pre">eval.ml</span></code> to handle function calls
involving the extended <code class="docutils literal notranslate"><span class="pre">Lambda</span></code> form.
Here are the semantics:</p>
<ul class="simple">
<li><p>If there is a “rest” argument:</p>
<ul>
<li><p>If there are too few required arguments,
raise a <code class="docutils literal notranslate"><span class="pre">CallErrorRest</span></code> exception
using the <code class="docutils literal notranslate"><span class="pre">call_err_rest</span></code> function.</p></li>
<li><p>Otherwise, bind the required arguments as usual,
collect all other arguments into a <em>uScheme</em> list,
and bind that list to the rest argument.</p></li>
</ul>
</li>
<li><p>If there is no “rest” argument,
just call the function the usual way.</p></li>
</ul>
</li>
</ol>
<p>You need to modify several different files in this problem:
<code class="docutils literal notranslate"><span class="pre">env.ml</span></code>, <code class="docutils literal notranslate"><span class="pre">env.mli</span></code>, <code class="docutils literal notranslate"><span class="pre">error.ml</span></code>, <code class="docutils literal notranslate"><span class="pre">error.mli</span></code>, and <code class="docutils literal notranslate"><span class="pre">eval.ml</span></code>.</p>
</section>
<section id="other-modifications">
<h2>7. Other modifications<a class="headerlink" href="#other-modifications" title="Permalink to this heading"></a></h2>
<p>You need to make a trivial modification in <code class="docutils literal notranslate"><span class="pre">uscheme.ml</span></code>
on line 52:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">scheme_basis</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</pre></div>
</div>
<p>Change this to:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">scheme_basis</span> <span class="o">=</span> <span class="nn">Basis</span><span class="p">.</span><span class="n">scheme_basis</span>
</pre></div>
</div>
<p>This will make the interpreter load the <em>uScheme</em> “basis”
(the built-in <em>uScheme</em> functions) when it starts.
The reason this change wasn’t already in the code
is because, if it were there,
the <em>uScheme</em> interpreter compiled from the unmodified code
would crash as soon as it started.
As is, it doesn’t, so you can run <em>e.g.</em> syntax tests
even if you haven’t made any changes to the code.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="partA_extending1.html" class="btn btn-neutral float-left" title="Part A: Finishing and extending uScheme : parsing" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="partC_programming.html" class="btn btn-neutral float-right" title="Part C: Programming in extended uScheme" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Michael C. Vanier. All rights reserved.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>