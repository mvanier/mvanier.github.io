
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://mvanier.github.io/cs131/Spring2025/book/assignments/5/partA_substitution/">
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.11">
    
    
      
        <title>Part A: Implementing capture-avoiding substitution (50 points) - The CS 131 book (Spring 2025)</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#part-a-implementing-capture-avoiding-substitution-50-points" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="The CS 131 book (Spring 2025)" class="md-header__button md-logo" aria-label="The CS 131 book (Spring 2025)" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            The CS 131 book (Spring 2025)
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Part A: Implementing capture-avoiding substitution (50 points)
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to medium mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to medium mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="medium" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18V6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-2.69L23.31 12 20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="The CS 131 book (Spring 2025)" class="md-nav__button md-logo" aria-label="The CS 131 book (Spring 2025)" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    The CS 131 book (Spring 2025)
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Introduction
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../intro/welcome/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Welcome to CS 131!
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../intro/software/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installing the course software
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lectures/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lecture slides
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Administrative
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Administrative
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../admin/syllabus/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Syllabus
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../admin/collab/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Collaboration policies
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-substmli-file" class="md-nav__link">
    <span class="md-ellipsis">
      The subst.mli file
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-substml-file" class="md-nav__link">
    <span class="md-ellipsis">
      The subst.ml file
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-implementing-subst" class="md-nav__link">
    <span class="md-ellipsis">
      1. Implementing subst
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Implementing subst">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#variable-capture" class="md-nav__link">
    <span class="md-ellipsis">
      Variable capture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#substitution-algorithm" class="md-nav__link">
    <span class="md-ellipsis">
      Substitution algorithm
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-implementing-rename_for_all_avoiding" class="md-nav__link">
    <span class="md-ellipsis">
      2. Implementing rename_for_all_avoiding
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="part-a-implementing-capture-avoiding-substitution-50-points">Part A: Implementing capture-avoiding substitution (50 points)</h1>
<p>The code you will write for this section is in the <code>Subst</code> module,
which consists of the files <code>subst.ml</code> and <code>subst.mli</code>.
You will only have to modify the <code>subst.ml</code> file.</p>
<h2 id="the-substmli-file">The <code>subst.mli</code> file</h2>
<p>The exported functions are given in the <code>subst.mli</code> file; they are:</p>
<div class="language-ocaml highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c">(** Return a set of all the free type variables in a type environment. *)</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="k">val</span> <span class="n">free_tyvars_gamma</span> <span class="o">:</span> <span class="nn">Type</span><span class="p">.</span><span class="n">type_env</span> <span class="o">-&gt;</span> <span class="nn">IdSet</span><span class="p">.</span><span class="n">t</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="c">(** Instantiate a quantified type by substituting actual types for</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="c">    type variables.  All substituted types must be of kind &quot;*&quot;.</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="c">    The `loc` argument is for error cases. *)</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="k">val</span> <span class="n">ty_instantiate</span> <span class="o">:</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>  <span class="nn">Loc</span><span class="p">.</span><span class="n">loc</span> <span class="o">-&gt;</span> <span class="n">ty_expr</span> <span class="o">-&gt;</span> <span class="n">ty_expr</span> <span class="kt">list</span> <span class="o">-&gt;</span> <span class="nn">Type</span><span class="p">.</span><span class="n">kind_env</span> <span class="o">-&gt;</span> <span class="n">ty_expr</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="c">(** Check if two types are equivalent. *)</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="k">val</span> <span class="n">equiv_type</span> <span class="o">:</span> <span class="n">ty_expr</span> <span class="o">-&gt;</span> <span class="n">ty_expr</span> <span class="o">-&gt;</span> <span class="kt">bool</span>
</span></code></pre></div>
<p>Even though you won't be directly implementing any of these,
it's worth spending a little time describing what they do.</p>
<ul>
<li>
<p><code>free_tyvars_gamma</code></p>
<p>We have been using the Greek letter "gamma" (<em>i.e.</em> <span class="arithmatex">\(\Gamma\)</span>)
in our type checking equations to refer to type environments.
A type environment maps variable names to their types,
and at certain points in type checking,
these types can contain type variables.
The function <code>free_tyvars_gamma</code> will return
a set of all the free type variables
from all the types in a type environment.
It uses an internal function called <code>free_tyvars</code>
to compute the free type variables of each type.</p>
<p>This function is implemented for you
and is used in a couple of places in the type checker.</p>
</li>
<li>
<p><code>ty_instantiate</code></p>
<p>This function takes a type expression (<code>ty_expr</code>),
which should be a <code>ForAll</code> type (or else it's an error).
It also takes a list of types to substitute
for the type variables of the <code>ForAll</code> type,
as well as a kind environment.
The function checks that
the number of type variables in the <code>ForAll</code> type
is the same as the number of supplied types,
and that all the supplied types have kind <code>*</code>
(which is a restriction of this language).<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>
If these checks pass,
the function substitutes the given types for the type variables.
It does this by creating a new type environment
and calling the <code>subst</code> function.</p>
<p>This function is implemented for you and is used in the type checker.</p>
</li>
<li>
<p><code>equiv_type</code></p>
<p>The <code>equiv_type</code> function compares two type expressions
and returns <code>true</code> if they are equivalent.
As discussed in lecture 18,
two type expressions don't have to be identical to be equivalent.
For instance, <code>(forall ['a] ('a -&gt; 'a))</code> and <code>(forall ['b] ('b -&gt; 'b))</code>
are not identical but they are equivalent.</p>
<p>This function is implemented for you,
based on the specification given in lecture 18.
The only complicated case is the <code>ForAll</code> case,
which uses the <code>rename</code> function,
which itself is defined in terms of the <code>subst</code> function.</p>
<p>This function is used in the type checker.</p>
</li>
</ul>
<h2 id="the-substml-file">The <code>subst.ml</code> file</h2>
<p>Even though all of the exported functions in the <code>Subst</code> module
(those described above) have been written for you,
the last two (<code>ty_instantiate</code> and <code>equiv_type</code>)
depend on a function called <code>subst</code>.
<code>subst</code>, in turn, depends on another function
called <code>rename_for_all_avoiding</code>,
which depends on a function called <code>rename</code>,
which depends on <code>subst</code>
(so the three functions are mutually recursive).
You will only need to complete the implementations
of <code>subst</code> and <code>rename_for_all_avoiding</code>.</p>
<p>The type signatures of these functions are as follows,
with some explanatory comments:</p>
<div class="language-ocaml highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c">(* Substitute type variables in a type expression with the bindings of those</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="c">   variables, yielding a new type. *)</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="k">val</span> <span class="n">subst</span> <span class="o">:</span> <span class="n">ty_expr</span> <span class="o">-&gt;</span> <span class="nn">Type</span><span class="p">.</span><span class="n">type_env</span> <span class="o">-&gt;</span> <span class="n">ty_expr</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="c">(* Rename a list of type variable names to a new list of type variable names</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="c">   in a type, yielding a new type. *)</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="k">val</span> <span class="n">rename</span> <span class="o">:</span> <span class="n">id</span> <span class="kt">list</span> <span class="o">-&gt;</span> <span class="n">id</span> <span class="kt">list</span> <span class="o">-&gt;</span> <span class="n">ty_expr</span> <span class="o">-&gt;</span> <span class="n">ty_expr</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="c">(* Rename all type variables in a `ForAll` type so as to avoid a particular</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="c">   set of possibly-captured variable names, yielding a new type. *)</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="k">val</span> <span class="n">rename_for_all_avoiding</span> <span class="o">:</span> <span class="n">id</span> <span class="kt">list</span> <span class="o">-&gt;</span> <span class="n">ty_expr</span> <span class="o">-&gt;</span> <span class="nn">IdSet</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="n">ty_expr</span>
</span></code></pre></div>
<p>We need to say a few more things about these functions.</p>
<ul>
<li>
<p><code>subst</code></p>
<p>In this function, the first argument can be any type expression.
The second is a "type environment", which in this program
just means a binding between identifiers and types.
However, this is <em>not</em> the usual type environment <span class="arithmatex">\(\Gamma\)</span>
that is in all the type checking equations.
It's not really an "environment" at all;
it's just a mapping between identifiers (in this case, type variables)
and the types that should be substituted for those type variables.
All this means is that you are substituting
multiple types for multiple type variables
simultaneously in a particular type,
yielding a new type.</p>
<p>In lecture 18, we listed the specification
for substituting a <em>single</em> type for a <em>single</em> type variable
while avoiding variable capture;
in your code you will need to generalize this
to handle multiple substitutions.
(Don't worry; you don't have to write out new equations!)</p>
<p>This function has five different cases
(because types have five different constructors);
four of these are trivial and are provided for you.
The one non-trivial case is for <code>ForAll</code> types,
which you have to write yourself.
The reason this is non-trivial
is that this is the only case where variable capture can occur.
We provide a walkthrough of the algorithm below.</p>
</li>
<li>
<p><code>rename</code></p>
<p>This function takes two equal-length lists of identifiers
representing type variables,
and renames all of the identifiers in the first list
to those of the second list in a type expression.
It does this by creating a mapping
between the original and the new names
and calling the <code>subst</code> function.</p>
</li>
<li>
<p><code>rename_for_all_avoiding</code></p>
<p>This function renames the type variables of a <code>ForAll</code> type
to avoid variable captures.
The first two arguments are the components of the <code>Forall</code> type
(the list of type variables and the rest of the expression).
The <code>IdSet.t</code> argument is a set of type variables which may be captured;
this is determined in the <code>subst</code> function.
The return value is the new <code>ForAll</code> type
with all the substitutions made.
The new type must be equivalent to the original type.</p>
</li>
</ul>
<p>Now we'll go into more detail
on how to implement <code>subst</code> and <code>rename_for_all_avoiding</code>.</p>
<h2 id="1-implementing-subst">1. Implementing <code>subst</code></h2>
<p>[<strong>30 points</strong>]</p>
<p><code>subst</code> takes two arguments:
a type (represented as a <code>ty_expr</code>)
and a mapping between type variable names and types
(represented as a <code>type_env</code>).
The mapping represents
the type variable substitutions that are to be made in the type.
We'll refer to the first argument as the "source type"
and the mapping as the "type map".
We'll refer to the output type as the "result type".</p>
<h3 id="variable-capture">Variable capture</h3>
<p>Naively,
you might think that all you have to do is to find
the locations of the type variables from the type map in the source type,
and then replace them with the types that the type variables map to.
However, this can easily lead to variable capture.
For instance,
naively substituting the type variable <code>'a</code>
for the type <code>('b -&gt; 'b)</code>
in the source type <code>(forall ['b] ('a -&gt; 'b))</code>
would yield the result type <code>(forall ['b] (('b -&gt; 'b) -&gt; 'b))</code>,
which is clearly wrong.
In this case we say that the <code>(forall ['b] ...)</code>
has <em>captured</em> the type variable <code>'b</code>,
which was originally a <em>free</em> variable in <code>('b -&gt; 'b)</code>.
This changes the meaning of the source type,
so that the result type is no longer equivalent to the source type,
and substitution is broken.</p>
<p>Instead, this substitution should yield a result type which is like
<code>(forall ['c] (('b -&gt; 'b) -&gt; 'c))</code>.
We can get this if we rename the source type
from <code>(forall ['b] ('a -&gt; 'b))</code>
to the equivalent type <code>(forall ['c] ('a -&gt; 'c))</code>
before doing the substitution.
But to do this correctly
we must make sure that we know how to do the renaming.</p>
<h3 id="substitution-algorithm">Substitution algorithm</h3>
<p>The substitution algorithm is as follows.
We will use the term "alphas list"
to refer to the list of quantified variables in the <code>ForAll</code> type.</p>
<ol>
<li>
<p>Compute all the free type variables in the <code>ForAll</code> type.
(By definition, these do <em>not</em> include any of the quantified variables.)</p>
</li>
<li>
<p>Collect all the types in the type map that the free type variables map to.
These types can potentially cause variable captures.
If a free type variable isn't mapped to a type in the type map,
include it too.
(Wrap it in a <code>TyVar</code> constructor,
since a type variable name by itself isn't a type).</p>
</li>
<li>
<p>Collect all the free type variables in all of the types from step 2
(including the unmapped free type variables).
Call these "potential captures".</p>
</li>
<li>
<p>Check to see if any of the free type variables
are also in the alphas list.</p>
<ol>
<li>
<p>If not, then we are in luck! No variable capture can occur.
Remove all the type variables in the alphas list
from the type map
(because the alphas list prevents them from being substituted)
and substitute the remaining type map
into the body of the <code>ForAll</code> type.
(This will involve a recursive call to <code>subst</code>.)</p>
</li>
<li>
<p>Otherwise, we have a variable capture situation.
Rename all the quantified values (the alphas list)
in the <code>ForAll</code> type so that they don't conflict
with any of the potential captures.
You'll do this by calling the <code>rename_for_all_avoiding</code> function
described in the next section.
Once this is done, then do the substitution.</p>
</li>
</ol>
</li>
</ol>
<p>This is not particularly hard code to write,
but small mistakes can lead to extremely subtle bugs
that are hard to track down.
The algorithm we give is purposely very conservative
so as to avoid problems.</p>
<p>Our solution required us to write less than 25 extra lines of code
(not including comments).</p>
<h2 id="2-implementing-rename_for_all_avoiding">2. Implementing <code>rename_for_all_avoiding</code></h2>
<p>[<strong>20 points</strong>]</p>
<p>The function <code>rename_for_all_avoiding</code> takes three arguments:</p>
<ol>
<li>
<p>the alphas list from a <code>ForAll</code> type
(<em>i.e.</em> the list of quantified variable names)</p>
</li>
<li>
<p>the body of a <code>ForAll</code> type
(<em>i.e.</em> everything but the list of quantified variable names)</p>
</li>
<li>
<p>a list of potentially captured type variables</p>
</li>
</ol>
<p>Note that the first two arguments are obtained
by taking the parts of a <code>ForAll</code> type.</p>
<p>The function returns a new <code>ForAll</code> type
formed by renaming any type variables
that are in the list of potential captures.
A partial implementation is provided for you.</p>
<p>Here is the renaming algorithm:</p>
<ol>
<li>
<p>If a type variable in the alphas list
is not in the potential captures list,
it can remain as it is.</p>
</li>
<li>
<p>Otherwise, pick a new type variable:</p>
<ul>
<li>
<p>which is different from all other type variables in the alphas list,</p>
</li>
<li>
<p>which is different from any new type variables
that may have been added previously in this algorithm,</p>
</li>
<li>
<p>which is not in the set of free variables
of the body of the <code>ForAll</code> type,</p>
</li>
<li>
<p>and which is not in the list of potential captures.</p>
</li>
</ul>
</li>
<li>
<p>Repeat the previous two steps
for all the type variables in the alphas list.
Then use the list of new type variables
to rename the entire type expression
(by calling the <code>rename</code> function, provided for you)
and construct a <code>ForAll</code> type out of the result.</p>
</li>
</ol>
<p>Our solution required us to write less than 10 extra lines of code
(not including comments).</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Some languages, notably Haskell, don't have this restriction,
so we say that they support "higher-kinded types".&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.copy", "navigation.footer", "navigation.top"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
        <script src="../../../js/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>